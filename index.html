<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>商城活動日曆</title>
  <style>
    /* 指定字體（同層資料夾：字體/ShopeeNotoSans(content)-Regular.ttf） */
    @font-face{
      font-family: "ShopeeNotoSansContent";
      src: url("字體/ShopeeNotoSans(content)-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    
    
    @font-face{
      font-family: "ShopeeNotoSansContentMedium";
      src: url("字體/ShopeeNotoSans(content)-Medium.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
@font-face{
      font-family: "ShopeeNotoSansContentBold";
      src: url("字體/ShopeeNotoSans(content)-Bold.ttf") format("truetype");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
:root{
      --W: 1200px;
      --H: 1863px;

      --red-a:#b80a16;
      --red-b:#d60f1c;
      --red-c:#e41824;
      --yellow:#ffd24a;

      --navy:#0f2f56;
      --navy2:#0c2a4c;
      --gridline:#d7d7d7;

      --orange:#f3a11a;
      --teal:#17b7a6;

      --logo-gray:#d8d8d8;

      --logo-inset-pct: 10;
      --logo-inset-scale: 0.9;
    }

    *{ box-sizing:border-box; font-family:"ShopeeNotoSansContent","PingFang TC","Microsoft JhengHei",system-ui,-apple-system,Arial,sans-serif; }
    body{
      margin:0;
      background:#111;
      color:#fff;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .wrap{
      width: var(--W);
      margin: 0 auto;
      height: auto;
      overflow:visible;
      background: #d0021b;
      position:relative;
      padding-bottom: 30px;
    }

    /* HERO */
    .hero{
      position:relative;
      padding: 94px 52px 10px;
      min-height: 315px;
          overflow:hidden;
    }

    .kv-bg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:0;
      pointer-events:none;
    }
    .hero > *:not(.kv-bg){
      position:relative;
      z-index:1;
    }

    .hero h1{
      margin:0;
      font-family:"ShopeeNotoSansContentMedium";
      font-weight:500;
      font-size: var(--h1-size, 41.9pt);
      line-height:1.1;
      letter-spacing:0;
      color: #ffdc5f;
    }
    .hero h2{
      margin: 10px 0 0;
      font-family:"ShopeeNotoSansContentBold";
      font-weight:700;
      font-size: var(--h2-size, 51.7pt);
      line-height:1.05;
      letter-spacing:0;
      color: #fdf2ca;
    }

    
    /* BENEFITS */

    .benefits{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 18px;
      padding: 4px 46px 0;
      margin: 0 0 10px;
      flex-wrap:wrap;
    }
    .benefit{
      font-family:"ShopeeNotoSansContent";
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 400;
      font-size: 24px;
      white-space:nowrap;
    }
    .benefit-icon{
      width: 40px;
      height: 40px;
      object-fit: contain;
      display:block;
    }
    .benefit-sep{
      width: auto;
      height: 40px;
      object-fit: contain;
    }

    .benefits{
      display:flex;
      justify-content:center;
      gap: 36px;
      padding: 4px 46px 0;
      margin: 0 0 10px;
      flex-wrap:wrap;
    }
    .benefit{
      font-family:"ShopeeNotoSansContent"; display:flex; align-items:center; gap: 12px; font-weight: 400; font-size: 24px; white-space:nowrap; }
    .icon{
      width: 40px; height: 40px;
      border-radius: 12px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.22);
      display:grid; place-items:center;
    }
    .icon svg{ width: 24px; height:24px; fill:#fff; opacity:.95; }

    /* CALENDAR */
    .calendar-shell{
      width: 1085px;
      margin: 10px auto 0;
      background:#fff;
      border-radius: 30px;
      overflow:hidden;
      box-shadow: 0 16px 40px rgba(0,0,0,.18);
    }
    .dow{
      height: 80px;
      background: linear-gradient(180deg, var(--navy) 0%, var(--navy2) 100%);
      display:grid;
      grid-template-columns: repeat(7, 155px);
      justify-content:center;
      align-items:center;
      color:#fff;
      font-weight: 900;
      letter-spacing: 10px;
      font-size: 30px;
      padding: 0 22px;
    }
    .dow div{ text-align:center; position:relative; }
    .dow div:not(:last-child)::after{
      content:"";
      position:absolute;
      right:-1px;
      top:50%;
      transform: translateY(-50%);
      width:2px;
      height:32px;
      background: rgba(255,255,255,.45);
    }

    .grid{
      position:relative;
      padding: 0 22px 22px;
      display:grid;
      grid-template-columns: repeat(7, 155px);
      grid-auto-rows: auto;         /* 依需求：高度 auto */
      justify-content:center;
      border-top: 1px solid var(--gridline);
    }
    .cell{
      position:relative;
      width:155px;
      min-height:252px;             /* 需要至少 248px 才能保持 date↔promo 間距 6px + 底部 6px */
      height:auto;
      border-right: 1px solid var(--gridline);
      border-bottom: 1px solid var(--gridline);
      background:#fff;
      overflow:hidden;
    }
    .cell:nth-child(7n){ border-right:none; }

    .date{
      position:absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      font-weight: 400;
      font-size: 32px;
      line-height: 32px;
      color:#111;
    }

    /* 第一列：三條置中、置下對齊（行距 6px，底部距離 6px） */
    .bars{
      width:140px;              /* 保持原本每格 140px */
      position:absolute;
      left:50%;
      bottom:6px;
      transform: translateX(-50%);
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
      z-index:3;
    }
    .promo95, .bar{
      width:140px;              /* 明確鎖定單顆寬度 */
      height:62px;
      flex: 0 0 auto;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .promo95{
      background:#ffd6df;
      color:#d0001c;
      font-weight:900;
      font-size:18px;
    }
    .bar.orange{ background: var(--orange); }
    .bar.teal{ background: var(--teal); }

    /* Keep bar vertical slots stable even when a bar is "removed" */
    .bar.is-removed{
      visibility: hidden;   /* takes space, but visually gone */
      pointer-events: none;
    }

    .logo-box{
      width:125px;
      height:49px;
      flex: 0 0 auto;
      border-radius:999px;
      background: #fff;           /* default white */
      box-sizing: border-box;
      padding: 4px;               /* make bg visible around the logo */
      overflow: hidden;           /* keep pill shape */
      display:flex;
      align-items:center;
      justify-content:center;
    }


/* Pending placeholder style for logo boxes (keeps "待補" readable) */
.logo-box.is-pending{
  background:#fff !important;
  color:#111 !important;
  font-size:16px;
  font-weight:900;
  display:flex;
  align-items:center;
  justify-content:center;
}
  
    /* PILL BLOCK (between benefits and dow) */
    .pill-block{
      display:flex;
      justify-content:center;
      gap:22px;
      margin: 0 0 8px;
    }
    .pill{
      width:255px;
      height:57px;
      background:#fff;
      border-radius:999px;
      display:flex;
      align-items:center;
      padding: 0;
      justify-content:center;
      gap:14px;
      box-sizing:border-box;
    }
    .pill .dot{
      width:28px;
      height:28px;
      border-radius:50%;
      flex:0 0 auto;
    }
    .pill.orange .dot{ background:#f3a11a; }
    .pill.teal .dot{ background:#17b7a6; }

    .pill.orange .text{
      color:#f3a11a;
    }
    .pill.teal .text{
      color:#17b7a6;
    }
    .pill .text{
      font-size:28px;
      font-weight:900;
      letter-spacing:1px;
      white-space:nowrap;
    }


    /* Floating size controls (top-left) */
    .float-panel{
      position: fixed;
      top: calc(12px + var(--tools-height, 0px) + 10px);
      left: 12px;
      z-index: 9999;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      padding: 12px 12px 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      color: #111;
      width: 260px;
    }
    .float-panel h3{
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .ctrl{
      display:grid;
      grid-template-columns: 52px 1fr 56px;
      align-items:center;
      gap: 8px;
      margin: 8px 0;
      font-size: 12px;
    }
    .ctrl input[type="range"]{
      width: 100%;
    }
    .pill-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 28px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.18);
      background: #fff;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .row-btns{ display:flex; gap:8px; margin-top:10px; }
    .hint{ font-size:11px; opacity:.75; margin-top:6px; line-height:1.3; }
    .sep{ height:1px; border:0; background: rgba(0,0,0,.12); margin: 10px 0; }


  
    /* Continuous band behind bars (keeps bar width unchanged) */
    .grid{ position:relative; }
    .band{
      position:absolute;
      height:62px;
      border-radius:999px;
      pointer-events:none;
      z-index:2; /* 僅作為連續底色，不影響單格寬度感 */
    }
    .band.orange{ background: var(--orange); }
    .band.teal{ background: var(--teal); }

    /* Bars keep original size; make their background transparent to reveal band */
    .bar.orange, .bar.teal{ background: transparent; }
    .bars{ z-index:3; }


    /* Floating top toolbar (semi-transparent) */
    .top-toolbar{
      position: fixed;
      top: 12px;
      left: 12px;
      right: auto;
      transform: none;
      width: auto;
      z-index: 10000;
      display:flex;
      gap: 10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color:#111;
    }
    .top-toolbar .tb-btn{
      height: 34px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.16);
      background: rgba(255,255,255,.9);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .top-toolbar .tb-btn:active{ transform: translateY(1px); }
    .top-toolbar .tb-btn svg{ width:18px; height:18px; fill:#111; opacity:.9; }
    .top-toolbar .tb-status{
      font-size: 12px;
      opacity: .75;
      max-width: 320px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    /* Keep toolbars from overlapping on very small screens */
    @media (max-width: 720px){
      .top-toolbar{ left: 12px; transform:none; right: 12px; justify-content: space-between; }
      .top-toolbar .tb-status{ display:none; }
    }


.logo-box{
  background:#fff !important;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.logo-box img{
  width: 100%;
  height: auto;
  max-width: 100%;
  max-height: none;
  object-fit: contain;
  display:block;
}


.promo-logo{
  width: 140px;
  height: auto;          /* IMPORTANT: avoid fixed height to prevent export distortion */
  min-height: 62px;      /* keep visual rhythm */
  display:flex;
  align-items:center;
  justify-content:center;
  overflow: visible;
}
/* Banner/promo images: scale by width, keep ratio */
.promo-logo img{
  display:block;
  width: 100%;
  height: auto;
  max-width: 100%;
  max-height: none;
}


        /* HERO background from KV-assets (optional) */
    .hero{
      width: 1200px;
      min-height: 315px;
      background-repeat: no-repeat;
      background-size: 1200px 315px; /* lock KV size */
      background-position: center top;
    }
    /* Slight overlay to keep text legible on busy images */
    .hero::before{
      content:"";
      position:absolute;
      inset:0;
      background: transparent; /* no overlay gradient */
      pointer-events:none;
      border-radius: 0;
    }
    .hero > *{ position: relative; z-index: 1; }


    /* TOOL AREA (separate from canvas; not captured in export) */
    .tool-area{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 0; /* toolbars are floating panels now */
      background: transparent;
      z-index: 9990;
      pointer-events:none;
    }


    
    /* Use intrinsic sizing (no object-fit) to ensure on-screen == exported via html2canvas */
    .logo-box,
    .promo-logo,
    .other-promos{
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .logo-box img,
    .promo-logo img,
    .other-promos img{
      display:block;
      max-width:100%;
      max-height:100%;
      cursor:pointer;
    }
    /* Width-first: fill container width; let height scale naturally */
    .fit-by-width{
      width:100% !important;
      height:auto !important;
      max-height:none !important;
    }


    
    /* Toggle fit mode for calendar logos (click to switch) */
    .logo-box,
    .promo-logo,
    .other-promos{
      display:flex;
      align-items:center;
      justify-content:center;
    }
    /* Default: fit by WIDTH (width-first) */
    .logo-box img,
    .promo-logo img,
    .other-promos img{
      display:block;
      width:100%;
      height:auto;
      max-width:100%;
      max-height:none;
      cursor:pointer;
    }
    /* Height-first (toggle state) */
    .fit-by-height{
      width:auto !important;
      height:100% !important;
      max-height:100% !important;
    }

    /* Fit defaults: width-first; toggle adds .fit-by-height */
    .logo-box img,
    .promo-logo img,
    .other-promos img{
      width: 100%;
      height: auto;
    }
    .fit-by-height{
      width:auto !important;
      height:100% !important;
      max-height:100% !important;
    }


    /* Drag-to-scale on logos (mouse down + horizontal drag) */
    .logo-box img,
    .promo-logo img,
    .other-promos img{
      transform-origin: center center;
      transition: transform 0.05s linear;
      user-select: none;
      -webkit-user-drag: none;
      --user-scale: 1;
      transform: scale(var(--logo-inset-scale,0.9)) scale(var(--user-scale,1));
    }


    /* Custom context menu for logo replacement */

    .logo-context-menu{
      position: fixed;
      z-index: 20000;
      background: #fff;
      border: 1px solid rgba(0,0,0,.15);
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,.18);
      padding: 6px;
      font-size: 13px;
      color: #111;
      user-select: none;
    }
    .logo-context-menu button{
      display:block;
      width:100%;
      padding:8px 12px;
      background: none;
      border: none;
      text-align:left;
      cursor:pointer;
      border-radius:6px;
      font-weight:600;
    }
    .logo-context-menu button:hover{
      background:#f2f2f2;
    }


/* === Benefit icon manual sizes (export-safe & screen-safe) === */
.benefit-icon[src*="15天鑑賞期"]{ width:50px; height:44px; }
.benefit-icon[src*="正品保障"]{ width:41px; height:47px; }
.benefit-icon[src*="蝦皮安心退"]{ width:50px; height:42px; }
.benefit-sep[src*="line"]{ width:43px; height:53px; }

</style>
</head>
<body>

  <!-- Tool area background (excluded from canvas capture) -->
  <div class="tool-area" aria-hidden="true"></div>


  <!-- Floating top toolbar -->
  <div class="top-toolbar" id="topToolbar" aria-label="tools">
    <button class="tb-btn" id="uploadTicketBtn" type="button" title="上傳工單">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 20h14v-2H5v2zm7-18-5.5 5.5 1.42 1.42L11 6.84V16h2V6.84l3.08 3.08 1.42-1.42L12 2z"/></svg>
      上傳工單
    </button>

    
    <button class="tb-btn" id="chooseKvBtn" type="button" title="選擇 KV-assets（hero 背景）">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2zm11 16H3V6h6.17L11.17 8H21v12z"/></svg>
      選擇KV背景
    </button>
    <button class="tb-btn" id="chooseLogoBtn" type="button" title="選擇 logo 資料夾（帶入品牌 Logo）">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
      選擇Logo資料夾
    </button>
<button class="tb-btn" id="downloadImgBtn" type="button" title="下載圖片（PNG）">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 20h14v-2H5v2zM11 4h2v8h3l-4 4-4-4h3V4z"/></svg>
      下載圖片
    </button>


    <button class="tb-btn" id="downloadCacheBtn" type="button" title="下載目前暫存（包含工單解析結果、KV/Logo圖片、Logo縮放設定）">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 20h14v-2H5v2zM11 4h2v8h3l-4 4-4-4h3V4z"/></svg>
      下載暫存檔
    </button>
    <button class="tb-btn" id="uploadCacheBtn" type="button" title="上傳暫存檔（還原KV/Logo/縮放/工單解析結果）">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19 15v4H5v-4H3v6h18v-6h-2zM11 16h2V8h3l-4-4-4 4h3v8z"/></svg>
      上傳暫存檔
    </button>

    <span class="tb-status" id="tbStatus">就緒</span>
    <input id="replaceLogoInput" type="file" accept="image/*" style="display:none" />
    <input id="ticketFileInput" type="file" accept=".xlsx,.xls" style="display:none" />
    <input id="logoDirInput" type="file" webkitdirectory multiple style="display:none" />
    <input id="kvDirInput" type="file" webkitdirectory multiple accept="image/*" style="display:none" />
    <input id="cacheFileInput" type="file" accept=".json,application/json" style="display:none" />
  </div>


  <div class="float-panel" id="sizePanel" aria-label="hero font size controls">
    <h3>Hero 字體大小調整</h3>

    <div class="ctrl">
      <div>H1</div>
      <input id="h1Range" type="range" min="40" max="90" step="0.05" value="41.9" />
      <div><span id="h1Val">41.9</span>pt</div>
    </div>

    <div class="ctrl">
      <div>H2</div>
      <input id="h2Range" type="range" min="40" max="110" step="0.05" value="51.7" />
      <div><span id="h2Val">51.7</span>pt</div>
    </div>

    <div class="row-btns">
      <button class="pill-btn" id="resetBtn" type="button">重設</button>
      <button class="pill-btn" id="toggleBtn" type="button">收合</button>
    </div>
    <div class="hint">只影響 .hero h1 / h2（使用 CSS 變數即時套用）。</div>

    <hr class="sep" />
    <h3 style="margin-top:0;">Logo 內縮</h3>
    <div class="ctrl">
      <div>%</div>
      <input id="logoInsetRange" type="range" min="0" max="30" step="0.5" value="10" />
      <div><span id="logoInsetVal">10</span>%</div>
    </div>
    <div class="hint">影響日曆 Logo／其他活動圖：預設內縮 10%。</div>
</div>
  </div>

  <main class="wrap" id="canvas">
    <section class="hero" aria-label="hero"><h1>8月商城活動日曆攻略</h1>
      <h2>免運吃到飽</h2>
<div class="pack-item bottle"></div>
        <div class="pack-item shoe"></div>
      </div>
    </section>

    
    <section class="benefits" aria-label="benefits">
      <div class="benefit">
        <img crossorigin="anonymous" class="benefit-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAGTElEQVRYhWIY1ICBgQEAAAD//xrcmIGBAQAAAP//fNAxDkBAFADRJxJxAIXaqfdMHEIUSt0WiuWLVlBPJplMFRFfkT0SBrQ4H/wWOzQv7oENBTV2ZKyYMGLG8nsIFwAAAP//YgA5EAeO/09b8Or///81////18Tphv//GQAAAAD//2LC43YrGse/KAMDQzMDA8N+BgaGPKwqGBgYAAAAAP//wudAftq4CwOIMzAwTGRgYJjFwMDAiiLLwMAAAAAA///C5UBGaBqkJ0hlYGBYArUbAhgYGAAAAAD//2LB4QJDBgYGfTSxzQwMDFuRPAADKQwMDMYMDAx3oSHxk4GBAeZxUMYyYmBgSCfSp2HQjFQE5jEwMAAAAAD//8KVOBOx5I8oHGrPQuX7cMj7kZHXfMB6//9nAAAAAP//whWCQljEPmIRE2ZgYNCCsp/jMCuWgYHhIgMDw0IGBgY+pJAFpTdQyIph0VPLwMCwnYGB4S8AAAD//8IVgv1oPrr3//9/aSzqVP////8dqiYTizz3////P////78Xhz3O/////40jFIP+///PAAAAAP//wpZJQLnXHk3sFjRtoAN1aCEOAo+wyHMzMDDwQAtubGAvNHNgAw4MDAwMAAAAAP//wuZABWgmQQZvcBhiC6VBtcJZLPKgmgbmUBiNjDkZGBgWMDAwLMeiN5aBgUEOAAAA///ClgYFsYh9xeFAayh9g4GB4QUWeTMoncXAwJDAwMDAjiYPqi5B1SBK0QIFAgwMDLIAAAAA///C5kB5LGKgRI4N8EIF3+OQB2UGUDSCHAYKMfT6HARAjgMFiiKGDAODIAAAAP//wuZA9PQHsvwoFnUgC7mgbFBDABtYBMWEQAgDA8NqDEUMDFIAAAAA//9CT4MgSz3RxF4zMDBcx6JZGxQFUPYZIhyBD2Ar1hgYGBiEAQAAAP//QncgKMrQ0yCoZviFRTOoMQGKus8MDAzHKHQg9vKYgYETAAAA//9CdyAo/aGLvcOhGRSCIPCMgYHhJoUORM88EMDA8BUAAAD//0J3DKjYQG9R7MOhGZb+vkEbpsQAbLkVBGA1DCpgYHgPAAAA//9CD1pvND6ogMUVfbDWjhoDA8MBqOW4HAASB4VSGgMDwwUs8qC2ISZgYHgCAAAA//9CdyC6QlDau4dFJ6gwBzkMBEAZCz3nYwOHGBgY7mCRAMWiDFYdDAzvAAAAAP//Qo5iUDCDSnZ08AGLGKimwWUoNnCFgYEhDkdxBAoUWIGODB4yMDDcBwAAAP//QnagOQMDgzSaIlAbD1stIkWC49YxMDC44ekgaTIwMEhiEV/GwMDwEgAAAP//QnagK5bctAtazKADWA2CD4DSWiADA0MwnqYYqLk/BYfcQQYGBgYAAAAA//9CToPYfIGrigN1RWEAFG3fobkZ5JkdDAwMS6GFO6iMxAVAdS0odGHFFTLYw8DAsJuBgYEBAAAA//9CbpttxtImc8TShhP8////Raj8zv///1v+//9f5f///5z4uo9oWOv////n8LSoHcDq/v9nAAAAAP//gmmUgTZK0YEJFsP1kBR1keAoGI75////GzyOQ5j5/z8DAAAA//+CpUELLK2Jx9BaAh0gF6qwxioxAFRLrWVgYFgM7SpgA6BmfhlcgoGBAQAAAP//gqVBUGJFB8dxOBCbWnwAlF4jGRgYSgn0tUHDIaA2IwIwMDAAAAAA///C58AjOAxSRWJ/wqEGVJ6CSgVQgyKfiJAGjS5EMzAwvEIRZWBgAAAAAP//AjkQNPgD6ruiA1CzCxadoKoK1PoFJQmQQTDgDKqOoFUiqHcG8iioqNJlYGCwJOAoGJjAwMBQjrXFxMDAAAAAAP//AiVEtf/////Ek2hpBW79///fF2+G+v+fAQAAAP//AoUgqLGIbQiNVgCU+UCdJNDAEa6WOAQwMDAAAAAA//8CORBbAU1tAOr0H4bWyf3Y0hpWwMDAAAAAAP//AjkQ1nWkJrgG7QaAGrKgLito0PI8yRYwMDAAAAAA//8COVAOGuygDjZoNBQZgEZJQdUXSBwUCqCqC9TCBrVwQPRLKA3qWIEwqLoDJXZQ8QTqy1AGGBgYAAAAAP//GtyYgYEBAAAA//8a3JiBgQEAAAD//xrcmIGBAQAAAP//AwAtmupQW/h26AAAAABJRU5ErkJggg==" alt="15天鑑賞期" />
        <span>15天鑑賞期</span>
      </div>

      <img class="benefit-sep" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAA1CAYAAADYgRIrAAAE70lEQVRogWIYMoCBgQEAAAD//xo6mIGBAQAAAP//GjqYgYEBAAAA//9iHIyu/f//vxQDAwMHlPuKkZHxCwMDAwMAAAD//xp0+P///yb/////+R8C7v///18ALMHAwAAAAAD//xpU+P///zz///+/BXXon////1vBHcjAwAAAAAD//xpsjl0IdSgI1KBIMjAwAAAAAP//GjT4////UUgOPfD//39mFMcxMDAAAAAA//8aFPj///9K/////wh16Nv////LYDiMgYEBAAAA//8acPz//3/W////n0AK1QCsjmJgYAAAAAD//xoMjm1Hcug0nAoZGBgAAAAA//8aUPz//3+n/////4U69Mr///85cTqIgYEBAAAA//8aMPz//3+R////P4M69Nv///918DqGgYEBAAAA//8aEPz//3/G////b0KK/iyCDmFgYAAAAAD//xoox+YiOXQDUZoYGBgAAAAA//+iO/7//7/+////v0Md+vj////CRDmCgYEBAAAA//+iK/7//z/X////ryFVpw5EO4CBgQEAAAD//6K3Y2ciRX8LSZoZGBgAAAAA//+iG/7//38wkkOP/f//n4UkyxkYGAAAAAD//6IL/v//v/z////fQR36/v///wokW8zAwAAAAAD//6I5BjVI/v//fwgpVCPIspSBgQEAAAD//6KHYxuQHDqXbIMYGBgAAAAA//+iKf7//78tNNeDwI3///9zk20hAwMDAAAA//+iGf7//7/g////H0IdCuqmGFJkGQMDAwAAAP//oqVj1yBFfyHFBjIwMAAAAAD//6IJ/v//fzqSQ7eC2gIUW8TAwAAAAAD//6I6/v//v+b///+/Qh36/P///+JUsYSBgQEAAAD//6Iq/v//P8f///8vQh367////65Us4CBgQEAAAD//6K2YycjRX8XVQ1nYGAAAAAA//+iGv7//78vNDRB4PT////ZqGoBAwMDAAAA//+iCgYN9/z///811KGf/v//r0p1SxgYGAAAAAD//6IY////n+n///97kaI/jiYWMTAwAAAAAP//ooZjK5EcuoRmFjEwMAAAAAD//6II////3/z///+/oA69+///fz6aWcbAwAAAAAD//yIbgxz2////e1CHghxsRlMLGRgYAAAAAP//osSxS5Giv4LmFjIwMAAAAAD//yIL////Px7JoXtAmYzmljIwMAAAAAD//yIZg4ql////f4Y6FFRcSdLFYgYGBgAAAAD//yIJgwr6////n0GqTn3oZjkDAwMAAAD//yLVsd1I0T+JrpYzMDAAAAAA//8iGv///98dqTq98P//f3a6OoCBgQEAAAD//yIKg5p50OYeCICaf5p0dwQDAwMAAAD//yKIoYNo25GiP3VAHMLAwAAAAAD//yLGsUVIDl09YA5hYGAAAAAA///Ci////2+ENCf1ANQJHDDHMDAwAAAAAP//womhc1Kg7jMIgLrTNgPqIAYGBgAAAAD//8KJ////Pw8p+usH3EEMDAwAAAAA///Civ///x+J5NCDg2JOioGBAQAAAP//wsCgQbP///9/gDoUNJgmNygcxsDAAAAAAP//QsGgYcj///8fRwrVoEHjOAYGBgAAAAD//0IZfIDWStJQ7l9GRsaHA+MsLICBgQEAAAD//xo6mIGBAQAAAP//GjqYgYEBAAAA//8DAKYHJHwjhI3lAAAAAElFTkSuQmCC" alt="" aria-hidden="true">

      <div class="benefit">
        <img crossorigin="anonymous" class="benefit-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAFgUlEQVRYhZTMMRWAMBTF0Pss4AEDGMFsJVQDAjrUxmdh6Fiy5GRJLFTVmrucuHB/PjDQ0fBg/p0mAS8AAAD//0LBIAeSgOX+///f8Z8wePT///+U////M5FiPhgwMDAAAAAA//8i14Em////v0mE45DB0v////OR5EAGBgYAAAAA//8ix4Hq////f0Gi42BgMUkOZGBgAAAAAP//YiEjzVUwMDCIYxE/zMDAsI6BgeELAwODHAMDQzQDA4MSmpoYaNqcSZRNDAwMAAAAAP//QsFE+Ezv////r9FC5d7///+dsESf2P///wv/////D039rv///zMSFYIMDAwAAAAA//8i1YFpaJaBohqUWfDpyfn///8PJD2P////L0yUAxkYGAAAAAD//8IVxewMDAx2DAwM/GjiTmj8bwwMDPoMDAxmuCIFSn+HmgkC0gwMDIUMDAwX0NSCiqZTKCIMDAwAAAAA///CVQ5qMTAwXGZgYGDCYTEtwEEGBgYHuMNA5SADAwMAAAD//8LlADEGBoZ/dHQcCIBCGRUwMDAAAAAA///C5UAZBgYGcnI4JUCAgYGBC8UABgYGAAAAAP//wuUIYTQ+KDTfMjAw/KRCtMPSESiWWJHEBRkYGESgaRECGBgYAAAAAP//wuVAZjT+CwYGBjcGBoY7DAwMbBQ68DfU/F0MDAxWSOKgslUUxYEMDAwAAAAA///C5UBkn4EAKH08hIYgCFMDfEYzBBTFkigiDAwMAAAAAP//whVd6GkBlKXQHU0pwGY3KO0jAAMDAwAAAP//wuVA9PIPBMhqi5EIuFHUMzAwAAAAAP//wuVAUIJFdxzWYoAC8BeLXlT3MDAwAAAAAP//wpYGQSU+ei7mY2Bg8GBgYLiHI5OADL7PwMDwBoscqEELSl+wcvUPVL0EDrsRgIGBAQAAAP//QsFIlfxZMppSoEYptnr1MAlmgBrAiBqNgYEBAAAA///CFsWgJjuouUQqwBZlIEBKsQQKaQRgYGAAAAAA///CFsWgAhRUYCKD1wwMDLUMDAwfoDkaBgwYGBjKCVgKkgdFM6xYAQUPKGCqGRgYtNHUgpIWSA6SHBgYGAAAAAD//0LB0OD1whL0oOY9tujTRVKTSGKfZiMWew79//+fHx7FDAwMAAAAAP//whbF6LUILKTRczYIYGtZEws4sSgENcUQ9jAwMAAAAAD//8LmQPw5iXrgFxajpKB5AAIYGBgAAAAA///ClgYxCksKgS00XcMAqJgBAQUs5nKgFHEMDAwAAAAA///C5kCMnEQhmMLAwKBHghmIGGRgYAAAAAD//8IWxeg5mFLwikQDEIHGwMAAAAAA//9CdyCuEh4XQC5ycFWbpLYfEUmMgYEBAAAA//9Cj2JQzgIlVGIBaNwlB9rSAfV3sYFeBgaGjQwMDD/QJEHtQlAbMxzNowgHMjAwAAAAAP//QncgSFKRBAc+ZWBgmEpAzTY8cqDoD0KrbRC5mIGBAQAAAP//Qg9+HgYGBnkSHEgpwBb9oFY1BDAwMAAAAAD//0JXAIpijI4LDQGWMTZwYQ0JUQYGBgAAAAD//8KWSXABXI0BSgC2OhfUUIGkQwYGBgAAAAD//8KWSbABkE9B5RO1u6LYuhGgASdQUnvPwMDAAAAAAP//QreQF4dBsgwMDIegrWpqjTaAWgSgMhfdkaD6HRKCDAwMAAAAAP//QncgrloEpE6DSg4jBkDcxcDAAAAAAP//Qg8NUNk0GADEXQwMDAAAAAD//0J34INB4Lrz0D44AwMDAwMAAAD//0J34A0GBoZ2+rsJDkC5uoCBgeEjWISBgQEAAAD//8I1/ObCwMCQDW0qUbvDjg28g1aH8xgYGC6BHQYafmNgYAAAAAD//wMAO+WcQXhJkQAAAAAASUVORK5CYII=" alt="正品保障" />
        <span>正品保障</span>
      </div>

      <img class="benefit-sep" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAA1CAYAAADYgRIrAAAE70lEQVRogWIYMoCBgQEAAAD//xo6mIGBAQAAAP//GjqYgYEBAAAA//9iHIyu/f//vxQDAwMHlPuKkZHxCwMDAwMAAAD//xp0+P///yb/////+R8C7v///18ALMHAwAAAAAD//xpU+P///zz///+/BXXon////1vBHcjAwAAAAAD//xpsjl0IdSgI1KBIMjAwAAAAAP//GjT4////UUgOPfD//39mFMcxMDAAAAAA//8aFPj///9K/////wh16Nv////LYDiMgYEBAAAA//8acPz//3/W////n0AK1QCsjmJgYAAAAAD//xoMjm1Hcug0nAoZGBgAAAAA//8aUPz//3+n/////4U69Mr///85cTqIgYEBAAAA//8aMPz//3+R////P4M69Nv///918DqGgYEBAAAA//8aEPz//3/G////b0KK/iyCDmFgYAAAAAD//xoox+YiOXQDUZoYGBgAAAAA//+iO/7//7/+////v0Md+vj////CRDmCgYEBAAAA//+iK/7//z/X////ryFVpw5EO4CBgQEAAAD//6K3Y2ciRX8LSZoZGBgAAAAA//+iG/7//38wkkOP/f//n4UkyxkYGAAAAAD//6IL/v//v/z////fQR36/v///wokW8zAwAAAAAD//6I5BjVI/v//fwgpVCPIspSBgQEAAAD//6KHYxuQHDqXbIMYGBgAAAAA//+iKf7//78tNNeDwI3///9zk20hAwMDAAAA//+iGf7//7/g////H0IdCuqmGFJkGQMDAwAAAP//oqVj1yBFfyHFBjIwMAAAAAD//6IJ/v//fzqSQ7eC2gIUW8TAwAAAAAD//6I6/v//v+b///+/Qh36/P///+JUsYSBgQEAAAD//6Iq/v//P8f///8vQh367////65Us4CBgQEAAAD//6K2YycjRX8XVQ1nYGAAAAAA//+iGv7//78vNDRB4PT////ZqGoBAwMDAAAA//+iCgYN9/z///811KGf/v//r0p1SxgYGAAAAAD//6IY////n+n///97kaI/jiYWMTAwAAAAAP//ooZjK5EcuoRmFjEwMAAAAAD//6II////3/z///+/oA69+///fz6aWcbAwAAAAAD//yIbgxz2////e1CHghxsRlMLGRgYAAAAAP//osSxS5Giv4LmFjIwMAAAAAD//yIL////Px7JoXtAmYzmljIwMAAAAAD//yIZg4ql////f4Y6FFRcSdLFYgYGBgAAAAD//yIJgwr6////n0GqTn3oZjkDAwMAAAD//yLVsd1I0T+JrpYzMDAAAAAA//8iGv///98dqTq98P//f3a6OoCBgQEAAAD//yIKg5p50OYeCICaf5p0dwQDAwMAAAD//yKIoYNo25GiP3VAHMLAwAAAAAD//yLGsUVIDl09YA5hYGAAAAAA///Ci////2+ENCf1ANQJHDDHMDAwAAAAAP//womhc1Kg7jMIgLrTNgPqIAYGBgAAAAD//8KJ////Pw8p+usH3EEMDAwAAAAA///Civ///x+J5NCDg2JOioGBAQAAAP//wsCgQbP///9/gDoUNJgmNygcxsDAAAAAAP//QsGgYcj///8fRwrVoEHjOAYGBgAAAAD//0IZfIDWStJQ7l9GRsaHA+MsLICBgQEAAAD//xo6mIGBAQAAAP//GjqYgYEBAAAA//8DAKYHJHwjhI3lAAAAAElFTkSuQmCC" alt="" aria-hidden="true">

      <div class="benefit">
        <img crossorigin="anonymous" class="benefit-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAE/0lEQVRYhWIY1ICBgQEAAAD//xrcmIGBAQAAAP//GtyYgYEBAAAA//+0zsENABAQALBeWNPDYCaxkCHEWcHHAE0amVnR0FGwP6wDBxMD60nhAgAA//8COdCKgYHhKB2D8jADA4MD1MH4AQMDAwAAAP//YmJgYFCio+NAQJeBgUGVKJUMDAwAAAAA//8CORAUrfQEnAwMDLJEWcjAwAAAAAD//wI5kKigpjIApUnCgIGBAQAAAP//AmUQcsADBgaGbQwMDH8ZGBhAnkQGIDFuBgYGfgYGBj8GBgY2NPn/SIECCklzNPmvDAwM28EsBgYGAAAAAP//Yvj//3/sf9LB4v///4P0EsLB/////4tm/Pf///87QeW347A6BSz//z8DAAAA//9C9z2xAJSOiAFrGRgYbuBRqIxD3BlMMjAwAAAAAP//IteBoGgiBoDS2j08Cr/gFWdgYAAAAAD//yLXgT9IcCA5ABIADAwMAAAAAP//IjeTmDIwMFRC2aBiCuSQLQwMDOep6EgGBgYGBgAAAAD//yLXgeoMDAxtaGLfcTgQH8CVltnBJAMDAwAAAP//IjaKzzIwMMQzMDDcx6PmIwkOg4XqTag+ZPyegYHhCFiWgYEBAAAA//8iJgSPMTAwBEMT7kI86vhIcCAMRDEwMEhBy1JQugPRoJh4BFbAwMAAAAAA//8i5MB10JADOU6QgYGhk4GBQQCH2pNEOgq5oP7GwMBwB6dKBgYGAAAAAP//wufAWQwMDOlIfFDQVxDpCHwAlKmIK6YYGBgAAAAA///C5sDP0AzQQQXHgBwCqvqQAajqmwf1MK4cDhJvYWBgWAsAAAD//8LmQFCGoIbjYIADi5giFOMDsgwMDAwAAAAA///ClotBjclJWCp5cgAoBHXI1PudgYGBAQAAAP//wlXM5EKb54R8SQgUMzAwSJKtm4GBAQAAAP//wpdJ7BgYGA5BHbsBKgaKegMGBoZPePSB0hwoWoWgZpAPGBgYAAAAAP//IlTMyDAwMKxmYGBoYmBgaGZgYHCHOpA+gIGBAQAAAP//IqagBqkBOVCB7t0DBgYGAAAAAP//IqUuTqKhO7CBbwwMDAwAAAAA//8CZRJym1y0BmEMDAy8AAAAAP//Ajnu1yB1oA8DA4MOAAAA//8COfACCQ1QeoJ/DAwMbwEAAAD//wKNLIA4oD4ACEtAh0FgaRPUwwLVyTAPJDMwMIghuXIVAwPDXRyZB1TcWDAwMDgiiYEaFPugbGFoa4YHyv/AwMCwDNrkAtm/n4GBYTsAAAD//0LvlbH8////G1Lv6hWa/DG03pcqgZ5dJJr6GjT5x0hy1zH0///PAAAAAP//Qs8gMN/AAMiXpQwMDOLQXGyIJk+od/cSjZ8DLbxB5s2AxhgMgPraqKUKAwMDAAAA///C5uuFWPqpP7CI7fj//z8bgRDk+////0s0faB+Mjbz8jD0///PAAAAAP//wmao7P///9/g6FDDAKjzbUpk5x09mrGBq////xfH0Pv/PwMAAAD//8JlqN7////v4DDs7f///12IdBwMF+Nx3NH///8rYdX3/z8DAAAA///CZ6jk////k////3/4////7////3/m////OfgMI4D1////3wz1OMi8zdChEVAywK73/38GAAAAAP//IpDGBxgwMDAAAAAA//8a3JiBgQEAAAD//xrcmIGBAQAAAP//AwBF5KD9qC9s5wAAAABJRU5ErkJggg==" alt="蝦皮安心退" />
        <span>蝦皮安心退</span>
      </div>
    </section>

	      <section class="pill-block" aria-label="campaign-types">
      <div class="pill orange">
        <span class="dot"></span>
        <span class="text">超級品牌日</span>
      </div>
      <div class="pill teal">
        <span class="dot"></span>
        <span class="text">今日旗艦店</span>
      </div>
    </section>

    <section class="calendar-shell" aria-label="calendar">
      <div class="dow">
        <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
      </div>
      </div>

      <div class="grid" id="grid">
        <!-- Week 1 (Aug starts on Fri) -->
        <div class="cell"><div class="date"></div></div>
        <div class="cell"><div class="date"></div></div>
        <div class="cell"><div class="date"></div></div>
        <div class="cell"><div class="date"></div></div>

        <div class="cell"><div class="date">1</div>
          <div class="bars" aria-hidden="true">
            
            <div class="bar orange"><div class="logo-box"></div></div>
            <div class="bar teal"><div class="logo-box"></div></div>
          </div>
        </div>

        <div class="cell"><div class="date">2</div>
          <div class="bars" aria-hidden="true">
            <div class="promo95">週日商城95折</div>
            <div class="bar orange"><div class="logo-box"></div></div>
            <div class="bar teal"><div class="logo-box"></div></div>
          </div>
        </div>

        <div class="cell"><div class="date">3</div>
          <div class="bars" aria-hidden="true">
            <div class="promo95">週日商城95折</div>
            <div class="bar orange"><div class="logo-box"></div></div>
            <div class="bar teal"><div class="logo-box"></div></div>
          </div>
        </div>

        <!-- Week 2 -->
        <div class="cell"><div class="date">4</div>
			<div class="bars" aria-hidden="true">
				<div class="promo95">週日商城95折</div>
		  <div class="bar orange"><div class="logo-box"></div></div>
            <div class="bar teal"><div class="logo-box"></div></div>
		  </div>
		  </div>
        <div class="cell"><div class="date">5</div></div>
        <div class="cell"><div class="date">6</div>
		  	<div class="bars" aria-hidden="true">
		  <div class="bar orange"><div class="logo-box"></div></div>
            <div class="bar teal"><div class="logo-box"></div></div>
		  </div>
		  </div>
        <div class="cell"><div class="date">7</div>
		  	<div class="bars" aria-hidden="true">
		  <div class="bar orange"><div class="logo-box"></div></div>
            <div class="bar teal"><div class="logo-box"></div></div>
		  </div></div>
        <div class="cell"><div class="date">8</div>
		  	<div class="bars" aria-hidden="true">
		  <div class="bar orange"><div class="logo-box"></div></div>
            <div class="bar teal"><div class="logo-box"></div></div>
		  </div></div>
        <div class="cell"><div class="date">9</div></div>
        <div class="cell"><div class="date">10</div></div>

        <!-- Week 3 -->
        <div class="cell"><div class="date">11</div></div>
        <div class="cell"><div class="date">12</div></div>
        <div class="cell"><div class="date">13</div></div>
        <div class="cell"><div class="date">14</div></div>
        <div class="cell"><div class="date">15</div></div>
        <div class="cell"><div class="date">16</div></div>
        <div class="cell"><div class="date">17</div></div>

        <!-- Week 4 -->
        <div class="cell"><div class="date">18</div></div>
        <div class="cell"><div class="date">19</div></div>
        <div class="cell"><div class="date">20</div></div>
        <div class="cell"><div class="date">21</div></div>
        <div class="cell"><div class="date">22</div></div>
        <div class="cell"><div class="date">23</div></div>
        <div class="cell"><div class="date">24</div></div>

        <!-- Week 5 -->
        <div class="cell"><div class="date">25</div></div>
        <div class="cell"><div class="date">26</div></div>
        <div class="cell"><div class="date">27</div></div>
        <div class="cell"><div class="date">28</div></div>
        <div class="cell"><div class="date">29</div></div>
        <div class="cell"><div class="date">30</div></div>
        <div class="cell"><div class="date">31</div></div>
      </div>
    </section>
  </main>

<script>
(function(){
  const root = document.documentElement;
  const h1 = document.getElementById('h1Range');
  const h2 = document.getElementById('h2Range');
  const h1Val = document.getElementById('h1Val');
  const h2Val = document.getElementById('h2Val');
  const resetBtn = document.getElementById('resetBtn');
  const toggleBtn = document.getElementById('toggleBtn');
  const panel = document.getElementById('sizePanel');

  const DEFAULT_H1 = 41.9;
  const DEFAULT_H2 = 51.7;

  const logoInset = document.getElementById('logoInsetRange');
  const logoInsetVal = document.getElementById('logoInsetVal');
  const DEFAULT_LOGO_INSET = 10;

  function applyLogoInset(){
    if(!logoInset) return;
    const pct = Math.max(0, Math.min(30, parseFloat(logoInset.value) || 0));
    const scale = (100 - pct) / 100;
    root.style.setProperty('--logo-inset-pct', pct.toFixed(1));
    root.style.setProperty('--logo-inset-scale', scale.toFixed(4));
    if(logoInsetVal) logoInsetVal.textContent = pct.toFixed(1).replace(/\.0$/, '');
    try{ localStorage.setItem('calendar_logo_inset_pct', String(pct)); }catch(e){}
  }

  function apply(){
    const v1 = parseFloat(h1.value);
    const v2 = parseFloat(h2.value);
    root.style.setProperty('--h1-size', v1.toFixed(2) + 'pt');
    root.style.setProperty('--h2-size', v2.toFixed(2) + 'pt');
    h1Val.textContent = v1.toFixed(2);
    h2Val.textContent = v2.toFixed(2);
    applyLogoInset();
  }

  h1.addEventListener('input', apply);
  h2.addEventListener('input', apply);
  if(logoInset) logoInset.addEventListener('input', applyLogoInset);

  resetBtn.addEventListener('click', () => {
    h1.value = DEFAULT_H1;
    h2.value = DEFAULT_H2;
    if(logoInset) logoInset.value = DEFAULT_LOGO_INSET;
    apply();
  });

  let collapsed = false;
  toggleBtn.addEventListener('click', () => {
    collapsed = !collapsed;
    panel.style.width = collapsed ? '120px' : '260px';
    Array.from(panel.querySelectorAll('.ctrl,.hint,.row-btns')).forEach(el => {
      el.style.display = collapsed ? 'none' : '';
    });
    toggleBtn.textContent = collapsed ? '展開' : '收合';
  });

  // Restore saved inset
  try{
    const saved = localStorage.getItem('calendar_logo_inset_pct');
    if(saved != null && logoInset){
      const v = parseFloat(saved);
      if(isFinite(v)) logoInset.value = String(v);
    }
  }catch(e){}

  apply();
})();
</script>


<script>
(function(){
  function buildBands(color){
    const grid = document.getElementById('grid');
    if(!grid) return;
    grid.querySelectorAll('.band.'+color).forEach(b=>b.remove());

    const cells = Array.from(grid.querySelectorAll('.cell'));
    const cols = 7;
    const gridRect = grid.getBoundingClientRect();

    for(let r=0; r<Math.ceil(cells.length/cols); r++){
      const row = cells.slice(r*cols, r*cols+cols);
      let i=0;
      while(i<row.length){
        const cell = row[i];
        const has = cell.querySelector('.bar.'+color);
        if(!has || (has.classList && has.classList.contains('is-removed'))){ i++; continue; }
        let j=i+1;
        while(j<row.length){
          const b = row[j].querySelector('.bar.'+color);
          if(!b || (b.classList && b.classList.contains('is-removed'))) break;
          j++;
        }

        const first = row[i];
        const last = row[j-1];
        const bar = first.querySelector('.bar.'+color);
        if(bar){
          const firstBar = first.querySelector('.bar.'+color);
          const lastBar  = last.querySelector('.bar.'+color);
          if(firstBar && lastBar){
            const firstBarRect = firstBar.getBoundingClientRect();
            const lastBarRect  = lastBar.getBoundingClientRect();

            const band = document.createElement('div');
            band.className = 'band ' + color;
            band.style.left   = (firstBarRect.left - gridRect.left) + 'px';
            band.style.top    = (firstBarRect.top - gridRect.top) + 'px';
            band.style.width  = (lastBarRect.right - firstBarRect.left) + 'px';
            band.style.height = firstBarRect.height + 'px';
            grid.appendChild(band);
          }
        }
        i = j;
      }
    }
  }

  function refresh(){
    buildBands('orange');
    buildBands('teal');
  }
  window.addEventListener('load', ()=>setTimeout(refresh,0));
  window.addEventListener('resize', refresh);
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
(function(){
  const uploadBtn = document.getElementById('uploadTicketBtn');
  const chooseKvBtn = document.getElementById('chooseKvBtn');
  const chooseLogoBtn = document.getElementById('chooseLogoBtn');
  const fileInput = document.getElementById('ticketFileInput');
  const statusEl = document.getElementById('tbStatus');
  const logoDirInput = document.getElementById('logoDirInput');
  const kvDirInput = document.getElementById('kvDirInput');

  let logoFileMap = new Map();
  let logoFolderFirstImageMap = new Map();
  let kvImageMap = new Map();
  let kvChosenUrl = null;
  
  // --- Image normalize: convert any uploaded image to JPEG (white background) first ---
  // This prevents semi-transparent PNGs from creating unexpected alpha and makes export consistent.
  const __objectUrlsToRevoke = new Set();
  function revokeTempObjectUrls(){
    for(const u of __objectUrlsToRevoke){
      try{ URL.revokeObjectURL(u); }catch(e){}
    }
    __objectUrlsToRevoke.clear();
  }

  async function fileToJpegDataURL(file, quality=0.95){
    // If file already is a jpeg, still normalize via canvas to ensure consistent decoding across browsers.
    return new Promise((resolve) => {
      try{
        const img = new Image();
        img.onload = async () => {
          try{
            const w = img.naturalWidth || img.width;
            const h = img.naturalHeight || img.height;
            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });

            // White background (so transparent pixels become white)
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, w, h);
            ctx.drawImage(img, 0, 0, w, h);

            // Export as data URL (ensures html2canvas can capture it)
            try{ const dataUrl = canvas.toDataURL('image/jpeg', quality); resolve(dataUrl); }
            catch(e){ resolve(canvas.toDataURL('image/jpeg', 0.95)); }
}catch(e){
            const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> resolve('');
        fr.readAsDataURL(file);
          }
        };
        img.onerror = () => {
          const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> resolve('');
        fr.readAsDataURL(file);
        };
        const src = URL.createObjectURL(file);
        __objectUrlsToRevoke.add(src);
        img.src = src;
      }catch(e){
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> resolve('');
        fr.readAsDataURL(file);
      }
    });
  }


  function setStatus(msg){ if(statusEl) statusEl.textContent = msg; }

  function normName(s){
    return String(s || "")
      .trim()
      .replace(/\s+/g, "")
      .replace(/[()（）]/g, "")
      .toLowerCase();
  }

  function splitWeekdayText(s){
    return String(s||"")
      .split(/[,\s、\/|]+/).map(t=>t.trim()).filter(Boolean);
  }

  function updateDow(dows){
    const dow = document.querySelector('.dow');
    if(!dow || !Array.isArray(dows) || dows.length !== 7) return;
    const divs = dow.querySelectorAll('div');
    if(divs.length === 7){
      divs.forEach((d,i)=> d.textContent = dows[i]);
    }else{
      dow.innerHTML = dows.map(x=>`<div>${x}</div>`).join('');
    }
  }

  function getCells(){ return Array.from(document.querySelectorAll('.grid .cell')); }

  function ensureBars(cell){
    let bars = cell.querySelector('.bars');
    if(!bars){
      bars = document.createElement('div');
      bars.className = 'bars';
      bars.setAttribute('aria-hidden','true');
      cell.appendChild(bars);
    }
    return bars;
  }

  function clearBars(bars){
    while(bars.firstChild) bars.removeChild(bars.firstChild);
  }

  function makePromoLogo(){
    const d = document.createElement('div');
    d.className = 'promo-logo';
    return d;
  }

  function makePromo95(){
    const d = document.createElement('div');
    d.className = 'promo95';
    d.textContent = '週日商城95折';
    return d;
  }

  function makeBar(color){
    const bar = document.createElement('div');
    bar.className = 'bar ' + color;
    const box = document.createElement('div');
    box.className = 'logo-box';
    bar.appendChild(box);
    return {bar, box};
  }

  function checkImage(url){
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve(true);
      img.onerror = () => resolve(false);
      img.src = url;
    });
  }

  async function resolveLogoSrc(campaignFolder, rawName){
    const base = normName(rawName).replace(/\.(png|jpg|jpeg)$/i,'');

    // Preferred: user-selected directory (recursive match to deepest jpg/png)
    if(logoFileMap.size){
      // exact match
      for(const [k, v] of logoFileMap.entries()){
        if(k === base || k === base + '.png' || k === base + '.jpg' || k === base + '.jpeg'){
          return v;
        }
      }
      // contains match (folder name / partial name)
      for(const [k, v] of logoFileMap.entries()){
        if(k.includes(base)){
          return v;
        }
      }
    }

    // Fallback: relative paths under /logo/<campaignFolder>/
    const candidates = [];
    const exts = ['png','jpg','jpeg'];
    const raw = String(rawName || '').trim();
    const rawNoExt = raw.replace(/\.(png|jpg|jpeg)$/i,'');
    for(const ext of exts){
      candidates.push(`logo/${campaignFolder}/${rawNoExt}.${ext}`);
      candidates.push(`logo/${campaignFolder}/${base}.${ext}`);
      // "name is folder" -> go one level deeper
      candidates.push(`logo/${campaignFolder}/${rawNoExt}/${rawNoExt}.${ext}`);
      candidates.push(`logo/${campaignFolder}/${base}/${base}.${ext}`);
    }
    for(const url of candidates){
      if(await checkImage(url)) return url;
    }
    return null;
  }

  async function resolveLogoSrcGeneric(rawName){
    const base = normName(rawName).replace(/\.(png|jpg|jpeg)$/i,'');
    // Prefer user-selected directory map
    if(logoFileMap.size){
      for(const [k, v] of logoFileMap.entries()){
        if(k === base || k === base + '.png' || k === base + '.jpg' || k === base + '.jpeg') return v;
      }
      for(const [k, v] of logoFileMap.entries()){
        if(k.includes(base)) return v;
      }
    }
    // Fallback: try relative URLs under ./logo/
    const candidates = [];
    const exts = ['png','jpg','jpeg'];
    const raw = String(rawName || '').trim();
    const rawNoExt = raw.replace(/\.(png|jpg|jpeg)$/i,'');
    const rawCompact = rawNoExt.replace(/\s+/g,'');
    for(const ext of exts){
      candidates.push(`logo/${rawNoExt}.${ext}`);
      candidates.push(`logo/${rawCompact}.${ext}`);
      // name-as-folder patterns
      candidates.push(`logo/${rawNoExt}/${rawNoExt}.${ext}`);
      candidates.push(`logo/${rawCompact}/${rawCompact}.${ext}`);
      candidates.push(`logo/${rawNoExt}/${rawCompact}.${ext}`);
      candidates.push(`logo/${rawCompact}/${rawNoExt}.${ext}`);
    }
    for(const url of candidates){
      if(await checkImage(url)) return url;
    }
    return null;
  }

  async function applyToHtml(calendarData){
    // 1) Update DOW
    if(calendarData.dows) updateDow(calendarData.dows);

    // 1.5) Update HERO titles from Excel (if provided)
    if(calendarData.heroH1 || calendarData.heroH2){
      const h1El = document.querySelector('.hero h1');
      const h2El = document.querySelector('.hero h2');
      if(h1El && calendarData.heroH1) h1El.textContent = calendarData.heroH1;
      if(h2El && calendarData.heroH2) h2El.textContent = calendarData.heroH2;
      setStatus('HERO 文案已更新');
    }

    const cells = getCells();

    // 2) Fill dates into HTML by row order (7 cells per week), from Excel directly
    const datesFlat = Array.isArray(calendarData.dateGrid) ? calendarData.dateGrid.flat() : [];

    // Clear all dates first
    cells.forEach(cell=>{
      const de = cell.querySelector('.date');
      if(de) de.textContent = '';
    });

    // Write dates sequentially into cells (keeps blanks)
    for(let i=0; i<cells.length && i<datesFlat.length; i++){
      const de = cells[i].querySelector('.date');
      if(de) de.textContent = datesFlat[i] ? String(datesFlat[i]).trim() : '';
    }

    // Hide/show the 5th week row based on actual weeks parsed from Excel
    const weeks = (typeof calendarData.actualWeeks === 'number') ? calendarData.actualWeeks : Math.ceil(datesFlat.length / 7);
    const showWeek5 = weeks >= 5;
    const start5 = 28; // 0-based index for the 29th cell (week 5)
    for(let i=start5; i<Math.min(cells.length, start5+7); i++){
      cells[i].style.display = showWeek5 ? '' : 'none';
    }

    // 3) Apply activities by the same cell index mapping (aligned to the 35 cells)
    const infos = Array.isArray(calendarData.cellInfo) ? calendarData.cellInfo : [];
    for(let i=0; i<cells.length && i<infos.length; i++){
      const info = infos[i];
      if(!info) continue;

      const cell = cells[i];
      const bars = ensureBars(cell);
      clearBars(bars);

      if(info.promo95) bars.appendChild(makePromo95());

      // Other promos: show fixed-size logo if found under ./logo/
      if(Array.isArray(info.otherPromos)){
        for(const promoName of info.otherPromos){
          const box = makePromoLogo();
          const src = await resolveLogoSrcGeneric(promoName);
          if(src){
            const img = document.createElement('img');
            img.crossOrigin = 'anonymous';
            img.alt = promoName;
            img.src = src;
            box.appendChild(img);
            bars.appendChild(box);
          }
        }
      }

      // Super Logo圖檔路徑 Day -> orange bar
      if(info.showOrange){
        const {bar, box} = makeBar('orange');
        const name = (info.orange || '').trim();
        if(name){
          const src = await resolveLogoSrc('超級品牌日', name);
          if(src){
            const img = document.createElement('img');
            img.crossOrigin = 'anonymous';
            img.alt = name;
            img.src = src;
            box.appendChild(img);
          }
        }
        bars.appendChild(bar);
      }

      // Today Flagship -> teal bar
      if(info.showTeal){
        const {bar, box} = makeBar('teal');
        const name = (info.teal || '').trim();
        if(name){
          const src = await resolveLogoSrc('今日旗艦店', name);
          if(src){
            const img = document.createElement('img');
            img.crossOrigin = 'anonymous';
            img.alt = name;
            img.src = src;
            box.appendChild(img);
          }
        }
        bars.appendChild(bar);
      }
    }

    // refresh continuous bands (existing script listens to resize)
    try{ window.dispatchEvent(new Event('resize')); }catch(e){}
  }
function extractCalendarFromSheet(ws){
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:""});
    const weekdaysSet = new Set(["日","一","二","三","四","五","六"]);
    let headerRow = -1;
    let headerCols = null;
    let dows = null;

    // Find weekday header row (either 7 separate cells, or one cell with delimiters)
    for(let r=0; r<rows.length; r++){
      const row = rows[r].map(v=>String(v).trim());
      const cols = [];
      for(let c=0; c<row.length; c++){
        if(weekdaysSet.has(row[c])) cols.push(c);
      }
      if(cols.length >= 7){
        headerRow = r;
        headerCols = cols.slice(0,7);
        dows = headerCols.map(c=>String(rows[r][c]).trim());
        break;
      }
      for(let c=0; c<row.length; c++){
        const parts = splitWeekdayText(row[c]);
        if(parts.length === 7 && parts.every(x=>weekdaysSet.has(x))){
          headerRow = r;
          headerCols = Array.from({length:7}, (_,i)=>c+i);
          dows = parts;
          break;
        }
      }
      if(headerRow !== -1) break;
    }
    if(headerRow === -1 || !headerCols) return null;

    // Build "活動日" mapping: day (1-31) -> filename (string) from a separate table (optional)
    const dayToFile = new Map();
    let actAnchor = null;
    for(let r=0; r<rows.length; r++){
      for(let c=0; c<rows[r].length; c++){
        if(String(rows[r][c]).trim() === "活動日"){
          actAnchor = {r, c};
          break;
        }
      }
      if(actAnchor) break;
    }
    if(actAnchor){
      for(let r=actAnchor.r+1; r<Math.min(rows.length, actAnchor.r+300); r++){
        const row = rows[r];
        let dayNum = null;
        for(let c=actAnchor.c; c<Math.min(row.length, actAnchor.c+25); c++){
          const n = parseInt(row[c], 10);
          if(!isNaN(n) && n>=1 && n<=31) dayNum = n;
        }
        if(!dayNum) continue;

        let fname = "";
        for(let c=row.length-1; c>=0; c--){
          const v = String(row[c]||"").trim();
          if(v){ fname = v; break; }
        }
        if(fname) dayToFile.set(dayNum, fname);
      }
    }

    // Helpers
    function isENDRow(row){
      if(!Array.isArray(row)) return false;
      return row.some(v => String(v ?? '').trim().toUpperCase() === 'END')
        || headerCols.some(c => String(row[c] ?? '').trim().toUpperCase() === 'END');
    }

    function isDateRow(row){
      if(!Array.isArray(row)) return false;
      // Consider only the 7 weekday columns
      const vals = headerCols.map(c => String(row[c] ?? '').trim());
      if(vals.some(v => v.toUpperCase() === 'END')) return false;

      const nonEmpty = vals.filter(v => v !== "");
      if(nonEmpty.length === 0) return false;

      // Numeric day cells
      const nums = vals.map(v => {
        const n = parseInt(v, 10);
        return (!isNaN(n) && n>=1 && n<=31) ? n : null;
      });
      const numericCount = nums.filter(n => n !== null).length;

      // Any non-empty that is not a day number is considered "not date row"
      const nonNumericNonEmpty = vals.filter(v => v !== "" && (isNaN(parseInt(v,10)) || parseInt(v,10)<1 || parseInt(v,10)>31));
      // Allow small amount of noise (e.g. remarks in one cell) by tolerating up to 1 noisy cell
      return numericCount >= 1 && nonNumericNonEmpty.length <= 1;
    }

    // Scan downward from the row after DOW: find each week date row dynamically,
    // read the next 4 rows as activity rows (per spec), then continue scanning.
    const dateGrid = [];
    const defaultWeeks = 4;
    const maxWeeks = 5;
    const cellInfo = [];
    let cellIndex = 0;

    let r = headerRow + 1;
    let weekCount = 0;
    while(r < rows.length && cellIndex < 35){
      const row = rows[r] || [];

      // Stop if we hit END
      if(isENDRow(row)) break;

      if(!isDateRow(row)){
        r++;
        continue;
      }

      const weekDates = headerCols.map(c => {
        const v = row[c];
        const n = parseInt(v, 10);
        return (isNaN(n) ? "" : String(n));
      });

      dateGrid.push(weekDates);

      weekCount++;

      // Read 4 rows beneath as activity lines (fixed 4 lines per your rule)
      for(let i=0; i<7; i++){
        const dayNum = parseInt(weekDates[i], 10);
        const col = headerCols[i];

        const lines = [];
        for(let k=1; k<=4; k++){
          const rr = rows[r+k] || [];
          const vv = String(rr[col] ?? "").trim();
          if(vv) lines.push(vv);
        }

        const promo95 = lines.includes("週日商城95折");
        const hasOrange = lines.includes("超級品牌日");
        const hasTeal = lines.includes("今日旗艦店");
        // Other promo text lines (e.g., '18 號會員日', '25 商城狂購節'...) -> resolve logo under ./logo/
        const otherPromos = lines.filter(t => t && !["週日商城95折","超級品牌日","今日旗艦店"].includes(t));

        cellInfo[cellIndex] = {
          promo95,
          showOrange: hasOrange,
          showTeal: hasTeal,
          orange: (hasOrange && !isNaN(dayNum)) ? (dayToFile.get(dayNum) || "") : "",
          teal: (hasTeal && !isNaN(dayNum)) ? (dayToFile.get(dayNum) || "") : "",
          otherPromos
        };
        cellIndex++;
      }

      // Move past this block (date row + 4 activity rows) and keep scanning
      r = r + 5;

      // Default: stop after 4 weeks. Exception: if a 5th date row exists BEFORE any END row, include it.
      if(weekCount >= defaultWeeks){
        // Try to find the next date row by scanning ahead
        let rr = r;
        let found5th = false;
        while(rr < rows.length){
          const row2 = rows[rr] || [];
          if(isENDRow(row2)) { found5th = false; break; }
          if(isDateRow(row2)) { found5th = true; break; }
          rr++;
        }
        if(!found5th) break;

        // Allow only one extra week (5th)
        if(weekCount >= maxWeeks) break;

        // Jump to the located 5th date row and continue
        r = rr;
      }
    }

    while(cellInfo.length < 35) cellInfo.push({promo95:false, showOrange:false, showTeal:false, orange:"", teal:"", otherPromos:[]});
    const actualWeeks = dateGrid.length;

    // Extract HERO text:
    // Find cell that contains '此為一整張MSBN' (tolerant: ignore spaces), then take the cell directly BELOW it.
    // The below cell may be multi-line (Alt+Enter) or single-line with separators.
    let heroH1 = "";
    let heroH2 = "";

    function normKey(s){
      return String(s ?? "").replace(/\s+/g,'').trim();
    }

    function splitHeroLines(s){
      const raw = String(s ?? "").trim();
      if(!raw) return [];
      // Prefer real newlines
      let parts = raw.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      if(parts.length >= 2) return parts;

      // Fallback separators
      parts = raw.split(/[|｜、，,\/／]+/).map(x=>x.trim()).filter(Boolean);
      if(parts.length >= 2) return parts;

      // Fallback: multiple spaces
      parts = raw.split(/\s{2,}/).map(x=>x.trim()).filter(Boolean);
      return parts;
    }

    for(let rr=0; rr<rows.length; rr++){
      for(let cc=0; cc<(rows[rr]||[]).length; cc++){
        const cellText = String(rows[rr][cc] ?? "").trim();
        if(!cellText) continue;

        if(normKey(cellText).includes(normKey("此為一整張MSBN"))){
          let below = String((rows[rr+1]||[])[cc] ?? "").trim();
          if(!below) below = String((rows[rr+2]||[])[cc] ?? "").trim();

          const lines = splitHeroLines(below);
          if(lines[0]) heroH1 = lines[0];
          if(lines[1]) heroH2 = lines[1];

          rr = rows.length; // break outer
          break;
        }
      }
    }


    // Do NOT pad to 5 here; we'll hide/show the 5th week in the UI based on actualWeeks.


    return { dows, dateGrid, cellInfo, actualWeeks, heroH1, heroH2 };
  }


  function dayFromValue(v){
    if(v == null) return null;

    // Date object
    if(Object.prototype.toString.call(v) === '[object Date]'){
      const d = v.getDate();
      return (isNaN(d) ? null : d);
    }

    // Excel serial date number (rough heuristic)
    if(typeof v === 'number'){
      if(v >= 30000 && window.XLSX && XLSX.SSF && XLSX.SSF.parse_date_code){
        const dc = XLSX.SSF.parse_date_code(v);
        if(dc && dc.d) return dc.d;
      }
      const n = Math.floor(v);
      if(n >= 1 && n <= 31) return n;
      return null;
    }

    const s = String(v).trim();
    if(!s) return null;

    // common yyyy-mm-dd / yyyy/mm/dd
    const m1 = s.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
    if(m1) return parseInt(m1[3], 10);

    // try last 1-2 digits at end
    const m2 = s.match(/(\d{1,2})\D*$/);
    if(m2) return parseInt(m2[1], 10);

    return null;
  }

  function extractLogo圖檔路徑LogoPlan(ws){
    // Find header row containing: 活動類型 / 活動日 / Logo圖檔路徑
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:""});

    let headerR = -1;
    let cType = -1, cDay = -1, cLogo圖檔路徑 = -1;

    for(let r=0; r<rows.length; r++){
      const row = rows[r].map(x=>String(x ?? '').trim());
      const idxType = row.findIndex(x=>x === '活動類型');
      const idxDay  = row.findIndex(x=>x === '活動日');
      const idxLogo圖檔路徑= row.findIndex(x=>x === 'Logo圖檔路徑');
      if(idxType !== -1 && idxDay !== -1 && idxLogo圖檔路徑 !== -1){
        headerR = r;
        cType = idxType; cDay = idxDay; cLogo圖檔路徑 = idxLogo圖檔路徑;
        break;
      }
    }
    if(headerR === -1) return { orangeByDay:new Map(), tealByDay:new Map() };

    const orangeByDay = new Map();
    const tealByDay   = new Map();

    for(let r=headerR+1; r<rows.length; r++){
      const row = rows[r] || [];
      const t = String(row[cType] ?? '').trim();
      const dRaw = row[cDay];
      const b = String(row[cLogo圖檔路徑] ?? '').trim();

      // stop when the whole line is empty-ish
      if(!t && !String(dRaw??'').trim() && !b) break;
      if(!t) continue;

      const day = dayFromValue(dRaw);
      if(!day || day < 1 || day > 31) continue;

      // Only care these two types
      if(t.includes('超級品牌日')){
        if(b) orangeByDay.set(day, b);
      }else if(t.includes('今日旗艦店')){
        if(b) tealByDay.set(day, b);
      }
    }

    return { orangeByDay, tealByDay };
  }

  function pickLogoUrlByLogo圖檔路徑(brandName){
    const bn = normName(brandName);
    if(!bn) return null;

    // Prefer folder map (e.g. 1206_屈臣氏)
    for(const [k, url] of logoFolderFirstImageMap.entries()){
      if(!k) continue;
      if(k.includes(bn) || bn.includes(k)) return url;
    }

    // Fallback to any indexed key (filename or segments)
    for(const [k, url] of logoFileMap.entries()){
      if(!k) continue;
      if(k.includes(bn) || bn.includes(k)) return url;
    }
    return null;
  }

  function ensureColorBarInCell(cell, color){
    const bars = ensureBars(cell);
    let bar = bars.querySelector('.bar.'+color);
    if(!bar){
      const made = makeBar(color);
      bar = made.bar;
      bars.appendChild(bar);
    }
    let box = bar.querySelector('.logo-box');
    if(!box){
      box = document.createElement('div');
      box.className = 'logo-box';
      bar.appendChild(box);
    }
    return {bar, box};
  }

  function setBoxToPending(box){
    box.innerHTML = '';
    box.textContent = '待補';
    try{ box.classList.add('is-pending'); }catch(e){}
    box.style.background = '#fff';
    box.style.color = '#111';
    box.style.fontSize = '16px';
    box.style.fontWeight = '900';
    box.style.display = 'flex';
    box.style.alignItems = 'center';
    box.style.justifyContent = 'center';

    // Make editable
    box.setAttribute('contenteditable', 'true');
    box.setAttribute('role', 'textbox');
    box.style.outline = 'none';

    // Auto-focus on click
    box.addEventListener('click', ()=>{
      box.focus();
      // place caret at end
      const r = document.createRange();
      r.selectNodeContents(box);
      r.collapse(false);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(r);
    }, {once:true});
  }

  function setBoxToImage(box, url, alt){
    // Clear any pending styles (e.g. 待補 white background)
    try{ box.classList.remove('is-pending'); }catch(e){}
    box.innerHTML = '';
    box.style.background = '';
    box.style.color = '';
    box.style.fontSize = '';
    box.style.fontWeight = '';
    box.style.display = '';
    box.style.alignItems = '';
    box.style.justifyContent = '';

    const img = document.createElement('img');
    img.crossOrigin = 'anonymous';
    img.alt = alt || '';
    img.src = url;
    // Force default: width-first (height auto) for ALL logos
    try{ img.dataset.forceWidth = '1'; }catch(e){}
    try{ img.classList && img.classList.remove('fit-by-height'); }catch(e){}
    box.appendChild(img);

    // Apply sampled background once loaded (and also next tick for fast loads)
    const apply = ()=>{
      try{
        if(window.__applyLogoBoxBgFromImg) window.__applyLogoBoxBgFromImg(img);
      }catch(e){}
    };
    img.addEventListener('load', apply, {once:true});
    setTimeout(apply, 0);
  }

  async function applyLogo圖檔路徑LogosFromSheet(){
    const ws = window.__lastSheet;
    if(!ws){ setStatus('尚未上傳工單，找不到「商城活動日曆」頁簽'); return; }

    const plan = extractLogo圖檔路徑LogoPlan(ws);
    const orangeByDay = plan.orangeByDay || new Map();
    const tealByDay = plan.tealByDay || new Map();

    if(!orangeByDay.size && !tealByDay.size){
      setStatus('在工單內找不到「活動類型/活動日/Logo圖檔路徑」表格');
      return;
    }

    const cells = getCells();
    let applied = 0;
    for(const cell of cells){
      const dEl = cell.querySelector('.date');
      const day = dEl ? parseInt(String(dEl.textContent||'').trim(), 10) : NaN;
      if(isNaN(day)) continue;

      if(orangeByDay.has(day)){
        const brand = orangeByDay.get(day);
        const {box} = ensureColorBarInCell(cell, 'orange');
        const url = pickLogoUrlByLogo圖檔路徑(brand);
        if(url) { setBoxToImage(box, url, brand); applied++; }
        else { setBoxToPending(box); }
      }
      if(tealByDay.has(day)){
        const brand = tealByDay.get(day);
        const {box} = ensureColorBarInCell(cell, 'teal');
        const url = pickLogoUrlByLogo圖檔路徑(brand);
        if(url) { setBoxToImage(box, url, brand); applied++; }
        else { setBoxToPending(box); }
      }
    }

    // refresh continuous bands
    try{ window.dispatchEvent(new Event('resize')); }catch(e){}
    setStatus(`Logo 套用完成（已套用 ${applied} 個；未找到圖片者顯示「待補」）`);
  }

  async function parseExcel(file){
    if(!window.XLSX){
      setStatus('缺少 XLSX 解析庫（請確認可連網載入 CDN）');
      return;
    }
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, {type:'array'});

    const target = wb.SheetNames.find(n => String(n).includes('商城活動日曆'));
    if(!target){
      setStatus('找不到頁簽：商城活動日曆');
      return;
    }
    const ws = wb.Sheets[target];

    window.__lastWorkbook = wb;
    window.__lastSheet = ws;

    const cal = extractCalendarFromSheet(ws);
    if(!cal){
      setStatus('找不到星期標題列（日/一/二/三/四/五/六）');
      return;
    }

    window.__lastCalendarData = cal;
    setStatus(`已讀取：${target}，套用中...`);
    await applyToHtml(cal);
    // KV-assets 選擇器需由使用者手動觸發（瀏覽器會阻擋非手勢開啟檔案選擇器）
const needLogo = (cal.cellInfo||[]).some(x => (x && (x.orange || x.teal)));
    if(needLogo && !logoFileMap.size){
      setStatus('已套用日曆；若要自動帶入 Logo，請點工具列「選擇Logo資料夾」');
    }else{
      setStatus('完成');
    }
  }


  function pickFirstKvUrl(){
    // Prefer deterministic selection by filename
    const entries = Array.from(kvImageMap.entries());
    if(!entries.length) return null;
    entries.sort((a,b)=> String(a[0]).localeCompare(String(b[0])));
    return entries[0][1];
  }

  function applyHeroBg(url){
    const hero = document.querySelector('.hero');
    if(!hero || !url) return;
    kvChosenUrl = url;
// keep a reference for export (background-image can be tricky with blob URLs)
    hero.dataset.kvSrc = url;

    // preload (helps html2canvas timing)
    let pre = document.getElementById('kvPreloadImg');
    if(!pre){
      pre = document.createElement('img');
      pre.id = 'kvPreloadImg';
      pre.alt = '';
      pre.style.position = 'fixed';
      pre.style.left = '-99999px';
      pre.style.top = '0';
      pre.style.width = '1px';
      pre.style.height = '1px';
      pre.style.opacity = '0';
      pre.style.pointerEvents = 'none';
      document.body.appendChild(pre);
    }
    pre.src = url;

    hero.style.backgroundImage = `url("${url}")`;
  }

  async function buildKvMapFromDir(files){
    kvImageMap = new Map();
    revokeTempObjectUrls();
    for(const f of files){
      if(!f) continue;
      const name = f.name || "";
      if(!/\.(png|jpg|jpeg|webp)$/i.test(name)) continue;
      const url = await fileToJpegDataURL(f);

      // Index by filename (normalized) and also keep original for sorting
      const key = normName(name);
      if(!kvImageMap.has(key)) kvImageMap.set(key, url);

      // Also index by path segments so any naming works
      if(f.webkitRelativePath){
        const parts = f.webkitRelativePath.split('/').filter(Boolean);
        for(const p of parts){
          const k = normName(p);
          if(k && !kvImageMap.has(k)) kvImageMap.set(k, url);
        }
      }
    }
    const first = pickFirstKvUrl();
    if(first) applyHeroBg(first);
  }

  async function buildLogoMapFromDir(files){
    logoFileMap = new Map();
    logoFolderFirstImageMap = new Map();
    revokeTempObjectUrls();

    for(const f of files){
      if(!f) continue;
      const name = f.name || "";
      if(!/\.(png|jpg|jpeg|webp)$/i.test(name)) continue;

      const url = await fileToJpegDataURL(f);

      // Index by filename and filename without ext
      const key1 = normName(name);
      const key2 = normName(name.replace(/\.(png|jpg|jpeg|webp)$/i,''));
      if(!logoFileMap.has(key1)) logoFileMap.set(key1, url);
      if(!logoFileMap.has(key2)) logoFileMap.set(key2, url);

      // Index by every path segment (folder-name matching rule) and also store first image per folder
      if(f.webkitRelativePath){
        const parts = f.webkitRelativePath.split('/').filter(Boolean);

        // parent folder (immediate)
        if(parts.length >= 2){
          const parent = parts[parts.length-2];
          const pk = normName(parent);
          if(pk && !logoFolderFirstImageMap.has(pk)) logoFolderFirstImageMap.set(pk, url);
        }

        for(const p of parts){
          const k = normName(p);
          if(k && !logoFileMap.has(k)) logoFileMap.set(k, url);

          // treat any folder segment as a "bucket"
          if(k && !logoFolderFirstImageMap.has(k)) logoFolderFirstImageMap.set(k, url);
        }
      }
    }
  }

  chooseLogoBtn && chooseLogoBtn.addEventListener('click', ()=>{
    if(!logoDirInput){ setStatus('找不到 logoDirInput'); return; }
    setStatus('請選擇 logo 資料夾：會依工單「活動類型/活動日/Logo圖檔路徑」自動對應（找不到則顯示 待補）');
    logoDirInput.click();
  });

  chooseKvBtn && chooseKvBtn.addEventListener('click', ()=>{
    if(!kvDirInput){ setStatus('找不到 kvDirInput'); return; }
    setStatus('請選擇同層資料夾「KV-assets」（hero 背景）');
    kvDirInput.click();
  });

  uploadBtn && uploadBtn.addEventListener('click', ()=>{
    setStatus('請選擇 Excel 檔（.xlsx/.xls）；完成後可選擇 KV-assets 資料夾套用 hero 背景');
    fileInput && fileInput.click();
  });

  fileInput && fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    setStatus(`讀取中：${f.name}`);
    // KV-assets / logo 資料夾改為由工具列按鈕手動選擇（避免連續跳出多個選擇視窗）

    try{
      await parseExcel(f);
    }catch(err){
      console.error(err);
      setStatus('解析失敗：請確認 Excel 格式 / 或可連網載入 XLSX CDN');
    }
    e.target.value = "";
  });

  kvDirInput && kvDirInput.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files || []);
    if(!files.length) return;
    await buildKvMapFromDir(files);
    setStatus(`已載入 KV-assets：${files.length} 檔，已套用 hero 背景（已先轉成 JPG）`);
    e.target.value = "";
  });

  logoDirInput && logoDirInput.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files || []);
    if(!files.length) return;
    await buildLogoMapFromDir(files);
    // 只影響「日曆內的Logo」與「其他活動圖（例如：18號會員日.PNG）」；不會動到 ICON 資料夾圖示。
    setStatus(`已載入 logo：${files.length} 檔（已先轉成 JPG），套用日曆活動圖與品牌日/旗艦店...`);
    try{
      if(window.__lastCalendarData){
        // 先套用其他活動圖（promo-logo），再套用 Logo圖檔路徑/day 到 bar（orange/teal，找不到顯示待補）
        await applyToHtml(window.__lastCalendarData);
      }
      await applyLogo圖檔路徑LogosFromSheet();
    }catch(err){
      console.error(err);
      setStatus('Logo 套用失敗：請確認工單表格/或 logo 資料夾結構');
    }
    e.target.value = "";
  });

  // ---- Persistence hooks (KV/Logo maps + apply functions)
  try{
    window.__kv_getMaps = ()=>({
      kvEntries: Array.from(kvImageMap.entries()),
      logoEntries: Array.from(logoFileMap.entries()),
      logoFolderFirstEntries: Array.from(logoFolderFirstImageMap.entries())
    });
    window.__kv_setMaps = (kvEntries, logoEntries, logoFolderFirstEntries)=>{
      kvImageMap = new Map(kvEntries || []);
      logoFileMap = new Map(logoEntries || []);
      logoFolderFirstImageMap = new Map(logoFolderFirstEntries || []);
      // If we have KV, apply first background immediately
      try{
        const first = pickFirstKvUrl();
        if(first) applyHeroBg(first);
      }catch(e){}
    };
    window.__kv_applyHeroBg = applyHeroBg;
    window.__kv_applyToHtml = applyToHtml;
    window.__kv_applyLogosFromSheet = applyLogo圖檔路徑LogosFromSheet;
  }catch(e){}

})();
</script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
(function(){
  function setStatus(msg){
    const el = document.getElementById('tbStatus');
    if(el) el.textContent = msg;
  }

  
  
  async function inlineImagesForExport(root){
    // Convert <img> in root to data URLs temporarily so html2canvas can always render them (blob/file/cors safe).
    // IMPORTANT: preserve any user edits (fit mode, scale, inline styles) and avoid triggering "auto-fit" logic during export.
    const imgs = Array.from(root.querySelectorAll('img'));
    // Fix: prevent benefit icons/separators from stretching in html2canvas export.
    // html2canvas can mis-render object-fit on <img> with only CSS sizing, so we enforce inline sizes in the CLONE.
    imgs.forEach((img)=>{
      
      // FIX: Do not override benefit icons/separators during export
      if(img.classList && (img.classList.contains('benefit-icon') || img.classList.contains('benefit-sep'))){
        return;
      }
try{
        if(img.classList && img.classList.contains('benefit-icon')){
          img.style.width = '40px';
          img.style.height = '40px';
          img.style.maxWidth = '40px';
          img.style.maxHeight = '40px';
          img.style.objectFit = 'contain';
          img.setAttribute('width','40');
          img.setAttribute('height','40');
        }else if(img.classList && img.classList.contains('benefit-sep')){
          img.style.height = '40px';
          img.style.maxHeight = '40px';
          img.style.width = 'auto';
          img.style.objectFit = 'contain';
        }
      }catch(e){}
    });

    const originals = new Map();

    function snap(img){
      return {
        src: img.getAttribute('src') || '',
        className: img.className || '',
        datasetScale: img.dataset ? (img.dataset.scale || '') : '',
        style: {
          userScale: (img.style && img.style.getPropertyValue) ? (img.style.getPropertyValue('--user-scale') || '') : '',
          transform: img.style.transform || '',
          width: img.style.width || '',
          height: img.style.height || '',
          maxWidth: img.style.maxWidth || '',
          maxHeight: img.style.maxHeight || ''
        }
      };
    }
    function restoreSnap(img, s){
      if(!s) return;
      try{ img.setAttribute('src', s.src); }catch(e){}
      try{ img.className = s.className; }catch(e){}
      try{
        if(img.dataset){
          if(s.datasetScale) img.dataset.scale = s.datasetScale;
          else delete img.dataset.scale;
        }
      }catch(e){}
      try{
        if(img.style && img.style.setProperty){
          const us = s.style.userScale || '';
          if(us) img.style.setProperty('--user-scale', us);
          else img.style.removeProperty('--user-scale');
        }
      }catch(e){}
      try{
        img.style.transform = s.style.transform;
        img.style.width = s.style.width;
        img.style.height = s.style.height;
        img.style.maxWidth = s.style.maxWidth;
        img.style.maxHeight = s.style.maxHeight;
      }catch(e){}
    }

    await Promise.all(imgs.map(async (img)=>{
      try{
        // Skip if already a data URL (e.g., built-in icons)
        const src = img.getAttribute('src') || '';
        if(src.startsWith('data:')) return;

        // Ensure loaded
        if(!(img.complete && img.naturalWidth > 0)){
          await new Promise(res=>{
            const done = ()=>res();
            img.addEventListener('load', done, {once:true});
            img.addEventListener('error', done, {once:true});
          });
        }
        if(!(img.naturalWidth > 0)) return;

        originals.set(img, snap(img));

        // Draw to canvas with white background to eliminate transparency
        const w = img.naturalWidth;
        const h = img.naturalHeight;
        const c = document.createElement('canvas');
        c.width = w;
        c.height = h;
        const ctx = c.getContext('2d', { willReadFrequently: true });
        ctx.fillStyle = '#fff';
        ctx.fillRect(0,0,w,h);
        ctx.drawImage(img, 0, 0, w, h);

        // Prefer jpeg for smaller size & consistent alpha handling
        const dataUrl = c.toDataURL('image/jpeg', 0.95);
        img.src = dataUrl;

        // Wait a tick for DOM to update
        await new Promise(r=>setTimeout(r, 0));
      }catch(e){
        // If anything fails, keep original
      }
    }));

    return function restore(){
      for(const [img, snapObj] of originals.entries()){
        restoreSnap(img, snapObj);
      }
    };
  }

  // --- Export helpers (clone-safe) ---
  function __isBlobOrFile(u){
    return /^blob:|^file:/i.test(String(u||''));
  }
  async function __fetchBlob(u, extra){
    const opts = Object.assign({ cache: 'no-cache' }, (extra||{}));
    // For blob:/file: URLs, avoid CORS mode; for http(s) keep cors
    if(__isBlobOrFile(u)){
      if(opts.mode) delete opts.mode;
      return fetch(u, opts);
    }
    opts.mode = opts.mode || 'cors';
    return fetch(u, opts);
  }

  async function fetchUrlToDataUrl(url){
    try{
      const resp = await __fetchBlob(url, { cache: 'force-cache' });
      const blob = await resp.blob();
      return await new Promise(res=>{
        const fr = new FileReader();
        fr.onload = ()=>res(fr.result);
        fr.onerror = ()=>res(null);
        fr.readAsDataURL(blob);
      });
    }catch(e){
      return null;
    }
  }

  function extractFirstBgUrl(bg){
    if(!bg || bg === 'none') return null;
    const m = bg.match(/url\((['"]?)(.*?)\1\)/i);
    return (m && m[2]) ? m[2] : null;
  }

  async function inlineBackgroundImageIntoClone(origElem, cloneElem){
    // Copy computed background styles from origElem -> cloneElem, then inline background-image url(...) into data URL.
    if(!origElem || !cloneElem) return null;
    const cs = window.getComputedStyle(origElem);
    let bgImg = cs.backgroundImage || 'none';
    // If background-image is not directly readable, fallback to data attribute (KV)
    if((!bgImg || bgImg === 'none') && origElem.dataset && origElem.dataset.kvSrc){
      bgImg = `url("${origElem.dataset.kvSrc}")`;
    }
    const bgColor = cs.backgroundColor || '';
    const prev = {
      backgroundImage: cloneElem.style.backgroundImage || '',
      backgroundColor: cloneElem.style.backgroundColor || '',
      backgroundRepeat: cloneElem.style.backgroundRepeat || '',
      backgroundSize: cloneElem.style.backgroundSize || '',
      backgroundPosition: cloneElem.style.backgroundPosition || ''
    };

    if(bgColor && bgColor !== 'rgba(0, 0, 0, 0)') cloneElem.style.backgroundColor = bgColor;
    cloneElem.style.backgroundRepeat = cs.backgroundRepeat;
    cloneElem.style.backgroundSize = cs.backgroundSize;
    cloneElem.style.backgroundPosition = cs.backgroundPosition;

    // Inline URL if present
    const url = extractFirstBgUrl(bgImg);
    if(url && !/^data:/i.test(url)){
      const dataUrl = await fetchUrlToDataUrl(url);
      if(dataUrl){
        const replaced = bgImg.replace(/url\((['"]?)(.*?)\1\)/i, `url("${dataUrl}")`);
        cloneElem.style.backgroundImage = replaced;
      }else{
        cloneElem.style.backgroundImage = bgImg;
      }
    }else{
      cloneElem.style.backgroundImage = bgImg;
    }

    return ()=>{ try{
      cloneElem.style.backgroundImage = prev.backgroundImage;
      cloneElem.style.backgroundColor = prev.backgroundColor;
      cloneElem.style.backgroundRepeat = prev.backgroundRepeat;
      cloneElem.style.backgroundSize = prev.backgroundSize;
      cloneElem.style.backgroundPosition = prev.backgroundPosition;
    }catch(e){} };
  }




  async function inlineHeroBackgroundForExport(){
    // Ensure .hero background-image (KV) is inlined as dataURL during export.
    // This avoids blob/file URL issues in some browsers.
    const hero = document.querySelector('#canvas .hero');
    if(!hero) return function(){};

    const originalBg = hero.style.backgroundImage || '';
    const computed = getComputedStyle(hero).backgroundImage || '';
    const bg = originalBg || computed;

    const m = bg.match(/url\(["']?(.+?)["']?\)/i);
    if(!m) return function(){};

    const url = m[1];
    if(!url || url.startsWith('data:')) return function(){};

    async function urlToDataURL(u){
      try{
        const resp = await __fetchBlob(u, {});
        const blob = await resp.blob();
        return await new Promise(res=>{
          const fr = new FileReader();
          fr.onload = ()=>res(fr.result);
          fr.onerror = ()=>res(null);
          fr.readAsDataURL(blob);
        });
      }catch(e){
        return null;
      }
    }

    const dataUrl = await urlToDataURL(url);
    if(!dataUrl) return function(){};

    hero.style.backgroundImage = `url("${dataUrl}")`;
    await new Promise(r=>setTimeout(r, 0));

    return function restore(){
      hero.style.backgroundImage = originalBg;
    };
  }


  async function inlineAllBackgroundImagesInClone(cloneRoot){
    // Walk through cloneRoot and inline any CSS background-image url(...) into data URLs.
    // This captures KV set on arbitrary layers (not only .hero/#canvas).
    if(!cloneRoot) return function(){};

    const nodes = [cloneRoot, ...Array.from(cloneRoot.querySelectorAll('*'))];
    const restores = [];

    async function urlToDataURL(u){
      try{
        const resp = await __fetchBlob(u, { cache:'no-cache' });
        const blob = await resp.blob();
        return await new Promise((res)=>{
          const fr = new FileReader();
          fr.onload = ()=>res(fr.result);
          fr.onerror = ()=>res(null);
          fr.readAsDataURL(blob);
        });
      }catch(e){
        // fetch can fail for some blob/file URLs in certain contexts; best-effort
        try{
          const img = new Image();
          img.crossOrigin = 'anonymous';
          const p = new Promise((resolve)=>{ img.onload=()=>resolve(true); img.onerror=()=>resolve(false); });
          img.src = u;
          const ok = await p;
          if(!ok) return null;
          const c = document.createElement('canvas');
          c.width = img.naturalWidth || img.width;
          c.height = img.naturalHeight || img.height;
          const ctx = c.getContext('2d');
          ctx.drawImage(img,0,0);
          return c.toDataURL('image/png');
        }catch(e2){
          return null;
        }
      }
    }

    // Limit concurrency a bit to avoid choking on many elements
    const MAX = 6;
    let idx = 0;
    async function worker(){
      while(idx < nodes.length){
        const i = idx++;
        const el = nodes[i];
        const cs = getComputedStyle(el);
        const bg = cs.backgroundImage || 'none';
        if(!bg || bg === 'none') continue;

        // Handle multiple backgrounds: url(...), linear-gradient, etc.
        // Replace each url(...) that isn't already data:
        const urls = [];
        const re = /url\((['"]?)(.*?)\1\)/ig;
        let m;
        while((m = re.exec(bg))){
          const u = m[2];
          if(u && !u.startsWith('data:')) urls.push(u);
        }
        if(!urls.length) continue;

        const prev = el.style.backgroundImage || '';
        let replaced = bg;
        for(const u of urls){
          const du = await urlToDataURL(u);
          if(du){
            // replace all occurrences of this exact url substring
            replaced = replaced.split(u).join(du);
          }
        }

        // If nothing changed, skip
        if(replaced === bg) continue;

        restores.push(()=>{ el.style.backgroundImage = prev; });
        el.style.backgroundImage = replaced;
      }
    }

    const workers = Array.from({length: MAX}, ()=>worker());
    await Promise.all(workers);
    await new Promise(r=>setTimeout(r, 0));

    return function restoreAll(){
      for(const r of restores){ try{ r(); }catch(e){} }
    };
  }

async function waitForCanvasAssets(){
    const root = document.getElementById('canvas');
    if(!root) return;

    // Wait for fonts
    try{
      if(document.fonts && document.fonts.ready) await document.fonts.ready;
    }catch(e){}

    // Wait for images (including object URLs)
    const imgs = Array.from(root.querySelectorAll('img'));
    // also wait for KV preload (if any)
    const kvPre = document.getElementById('kvPreloadImg');
    if(kvPre) imgs.push(kvPre);
    await Promise.all(imgs.map(img=>{
      // already loaded
      if(img.complete && img.naturalWidth > 0) return Promise.resolve();
      return new Promise(resolve=>{
        const done = ()=>resolve();
        img.addEventListener('load', done, {once:true});
        img.addEventListener('error', done, {once:true}); // still resolve to avoid hanging
      });
    }));

    // Extra: try decode() for crisper render in some browsers
    await Promise.all(imgs.map(img=>{
      try{
        if(img.decode) return img.decode().catch(()=>{});
      }catch(e){}
      return Promise.resolve();
    }));
  }


async function captureAndDownload(format){
    // IMPORTANT:
    // Export MUST NOT mutate the live DOM (otherwise logo edits like scale/fit can "jump back").
    // We clone #canvas, inline assets only inside the clone, then render the clone with html2canvas.
    window.__EXPORTING = true;

    const target = document.getElementById('canvas');
    if(!target) { setStatus('找不到畫布'); window.__EXPORTING = false; return; }

    if(!window.html2canvas){
      setStatus('缺少 html2canvas（請確認可連網載入 CDN）');
      window.__EXPORTING = false;
      return;
    }

    setStatus('產生圖片中...');
    await waitForCanvasAssets(); // ensure current (edited) images are fully loaded before cloning

    // 1) Clone the canvas area (keeps all current user edits: classList, inline styles, dataset.scale, etc.)
    const clone = target.cloneNode(true);

    // 2) Put clone off-screen so it can be measured / rendered
    const holder = document.createElement('div');
    holder.style.position = 'fixed';
    holder.style.left = '-99999px';
    holder.style.top = '0';
    holder.style.width = (target.offsetWidth || target.getBoundingClientRect().width) + 'px';
    holder.style.height = (target.offsetHeight || target.getBoundingClientRect().height) + 'px';
    holder.style.pointerEvents = 'none';
    holder.style.opacity = '0';
    holder.appendChild(clone);
    document.body.appendChild(holder);

    // 2.5) Disable shadows during export to prevent gray blocks around rounded corners (html2canvas artifact)
    try{
      clone.querySelectorAll('.calendar-shell').forEach(el=>{
        el.style.boxShadow = 'none';
        el.style.filter = 'none';
      });
    }catch(e){}

    // 3) Inline KV background + all <img> ONLY inside the clone
    //    (so original logo sizing / appearance never changes)
    let restoreBgHero = null;
    let restoreBgCanvas = null;
    let restoreAllBg = null;
    let restoreImgsClone = null;
    try{
      // Inline hero/KV background in clone (including url(...) -> dataURL):
      const origHero = target.querySelector('.hero');
      const cloneHero = clone.querySelector('.hero');
      if(origHero && cloneHero){
        restoreBgHero = await inlineBackgroundImageIntoClone(origHero, cloneHero);
      }

      // Some templates put KV on #canvas itself; inline it too (safe no-op if none)
      restoreBgCanvas = await inlineBackgroundImageIntoClone(target, clone);

      // Inline ANY other background-image layers inside clone (KV often lives here)
      restoreAllBg = await inlineAllBackgroundImagesInClone(clone);



      // Inline <img> inside clone (convert to data URLs)
      restoreImgsClone = await inlineImagesForExport(clone);

      // 4) Render clone
      const rect = target.getBoundingClientRect();
      const scale = Math.min(3, Math.max(1, (window.devicePixelRatio || 1)));
      const bgColor = (format === 'jpeg' || window.__FORCE_SOLID_BG) ? '#d0021b' : null;
      const c = await window.html2canvas(clone, {
        backgroundColor: bgColor,
        scale,
        useCORS: true,
        allowTaint: true,
        logging: false,
        width: Math.round(rect.width),
        height: Math.round(rect.height),
        windowWidth: Math.round(rect.width),
        windowHeight: Math.round(rect.height),
      });

      const ext = (format === 'jpeg') ? 'jpg' : 'png';
      const mime = (format === 'jpeg') ? 'image/jpeg' : 'image/png';
      const dataUrl = c.toDataURL(mime, (format === 'jpeg') ? 0.95 : 1.0);

      const a = document.createElement('a');
      const title = (document.title || 'calendar').replace(/[\/:*?"<>|]/g,'_');
      a.download = `${title}.${ext}`;
      a.href = dataUrl;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setStatus(`已下載 ${ext.toUpperCase()}`);
    }catch(e){
      console.error(e);
      const msg = (e && (e.name || e.message)) ? `${e.name || 'Error'}: ${e.message || ''}` : '未知錯誤';
      setStatus('下載失敗：' + msg + '（常見原因：用 file:// 開啟或圖片未允許 CORS。建議用本機伺服器開啟。）');
    }finally{
      try{ if(restoreBgHero) restoreBgHero();
      if(restoreBgCanvas) restoreBgCanvas();
      if(restoreAllBg) restoreAllBg(); }catch(e){}
      try{ if(restoreImgsClone) restoreImgsClone(); }catch(e){}
      try{ holder.remove(); }catch(e){}
      window.__EXPORTING = false;
    }
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('downloadImgBtn');
    if(!btn) return;

    btn.addEventListener('click', (ev)=>{
      window.__FORCE_SOLID_BG = false; // JPEG will be solid background
      const fmt = ev.shiftKey ? 'png' : 'jpeg';
      captureAndDownload(fmt);
    });
btn.title = '下載圖片（預設JPG；按住Shift下載PNG）';
  });
})();
</script>


<script>
(function(){
  function setToolsHeight(){
    const tb = document.getElementById('topToolbar');
    if(!tb) return;
    const h = tb.offsetHeight || 0;
    document.documentElement.style.setProperty('--tools-height', h + 'px');
  }
  window.addEventListener('load', setToolsHeight);
  window.addEventListener('resize', setToolsHeight);
  // update after status text changes (rough)
  const obs = new MutationObserver(()=>setToolsHeight());
  const tb = document.getElementById('topToolbar');
  if(tb) obs.observe(tb, {subtree:true, childList:true, characterData:true});
})();
</script>


<script>
(function(){
  function setStatus(msg){
    const el = document.getElementById('tbStatus');
    if(el) el.textContent = msg;
  }
  window.addEventListener('load', ()=>{
    if(location.protocol === 'file:'){
      setStatus('提示：建議用本機伺服器（例如 VS Code Live Server）以確保下載圖片功能正常（避免 file:// 跨域限制）');
    }
  });
})();
</script>


<script>
(function(){
  function fallbackIconPath(){
    const imgs = document.querySelectorAll('img');
    imgs.forEach(img=>{
      img.addEventListener('error', ()=>{
        const s = img.getAttribute('src') || '';
        // only handle ICON/icon folder assets
        if(s.startsWith('ICON/')){
          img.src = 'icon/' + s.slice(5);
        }else if(s.startsWith('icon/')){
          img.src = 'ICON/' + s.slice(5);
        }
      }, { once: true });
    });
  }
  window.addEventListener('DOMContentLoaded', fallbackIconPath);
})();
</script>



<script>
(function(){
  function isCalendarLogoImg(img){
    if(!img || img.tagName !== 'IMG') return false;
    if(img.classList && (img.classList.contains('benefit-icon') || img.classList.contains('benefit-sep'))) return false;
    return !!(img.closest('.logo-box') || img.closest('.promo-logo') || img.closest('.other-promos'));
  }

  function applyDefaultFit(img){
    // Default is ALWAYS width-first for all logos.
    // (Users can still toggle fit-by-height via dblclick if needed.)
    return;
  }

  // Apply default fit after each image loads
  document.addEventListener('load', function(e){
    if(window.__EXPORTING) return;
    const img = e.target;
    if(img && img.tagName === 'IMG' && isCalendarLogoImg(img)){
      applyDefaultFit(img);
    }
  }, true);

  // Toggle on click
  document.addEventListener('dblclick', function(e){
  const img = (e.target && e.target.tagName === 'IMG') ? e.target : null;
  if(!img) return;
  if(img.classList && (img.classList.contains('benefit-icon') || img.classList.contains('benefit-sep'))) return;
  if(!(img.closest('.logo-box') || img.closest('.promo-logo') || img.closest('.other-promos'))) return;
  e.preventDefault();
  img.classList.toggle('fit-by-height');
});
})();
</script>



<script>
(function(){
  function getPixel(ctx, x, y){
    const d = ctx.getImageData(x,y,1,1).data;
    return {r:d[0], g:d[1], b:d[2], a:d[3]};
  }

  
  
  function sampleCornerNonTransparent(img){
    try{
      const w = img.naturalWidth || 0;
      const h = img.naturalHeight || 0;
      if(!w || !h) return null;

      const scan = 5;
      const canvas = document.createElement('canvas');
      canvas.width = scan;
      canvas.height = scan;
      const ctx = canvas.getContext('2d', { willReadFrequently: true });

      // draw TOP-RIGHT corner into canvas (5x5)
      ctx.drawImage(
        img,
        Math.max(0, w - scan),
        0,
        scan,
        scan,
        0,
        0,
        scan,
        scan
      );

      const data = ctx.getImageData(0, 0, scan, scan).data;
      for(let i = 0; i < data.length; i += 4){
        const a = data[i+3];
        if(a > 0){
          const r = data[i];
          const g = data[i+1];
          const b = data[i+2];
          return `rgb(${r}, ${g}, ${b})`;
        }
      }
      return null;
    }catch(e){
      return null;
    }
  }
function applyLogoBoxBgFromImg(img){
    const box = img.closest('.logo-box');
    if(!box) return;

    const color = sampleCornerNonTransparent(img);

    // Always apply: if no color (transparent), force white background.
    if(color){
      box.style.setProperty('background', color, 'important');
    }else{
      box.style.setProperty('background', '#fff', 'important');
    }
  }

  function applyAll(){
    document.querySelectorAll('.logo-box img').forEach(img=>{
      if(img.complete && img.naturalWidth > 0){
        applyLogoBoxBgFromImg(img);
      }
    });
  }

  // When any logo loads, apply background
  document.addEventListener('load', function(e){
    if(window.__EXPORTING) return;
    const img = e.target;
    if(img && img.tagName === 'IMG' && img.closest('.logo-box')){
      applyLogoBoxBgFromImg(img);
    }
  }, true);

  // Also run after DOM ready and after any click-toggles (images may already be complete)
  window.addEventListener('DOMContentLoaded', ()=>{
    applyAll();
  });

  document.addEventListener('click', function(e){
    if(window.__EXPORTING) return;
    const img = (e.target && e.target.tagName === 'IMG') ? e.target : null;
    if(img && img.closest('.logo-box')){
      setTimeout(()=>applyLogoBoxBgFromImg(img), 0);
    }
  });

  // Expose for debugging
  window.__applyLogoBoxBg = applyAll;
  window.__applyLogoBoxBgFromImg = applyLogoBoxBgFromImg;
})();
</script>


<script>
(function(){
  // Only for calendar logos / promo images; never affect benefit icons
  function isScalableLogoImg(img){
    if(!img || img.tagName !== 'IMG') return false;
    if(img.classList && (img.classList.contains('benefit-icon') || img.classList.contains('benefit-sep'))) return false;
    return !!(img.closest('.logo-box') || img.closest('.promo-logo') || img.closest('.other-promos'));
  }

  function getScale(img){
    const s = parseFloat(img.dataset.scale || '1');
    return isFinite(s) ? s : 1;
  }
  function setScale(img, s){
    const clamped = Math.max(0.4, Math.min(2.2, s)); // reasonable bounds
    img.dataset.scale = String(clamped);
    // Keep transform logic in CSS so we can compose: inset-scale * user-scale
    img.style.setProperty('--user-scale', String(clamped));
    // Ensure no inline transform overrides CSS composition
    img.style.transform = '';
  }

  let activeImg = null;
  let startX = 0;
  let startScale = 1;

  function onDown(e){
    const img = e.target && e.target.tagName === 'IMG' ? e.target : null;
    if(!isScalableLogoImg(img)) return;

    e.preventDefault();
    activeImg = img;
    startX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    startScale = getScale(img);

    // If image hasn't been scaled before, ensure style matches dataset
    setScale(img, startScale);

    window.addEventListener('mousemove', onMove, {passive:false});
    window.addEventListener('mouseup', onUp, {passive:false});
    window.addEventListener('touchmove', onMove, {passive:false});
    window.addEventListener('touchend', onUp, {passive:false});
  }

  function onMove(e){
    if(!activeImg) return;
    e.preventDefault();
    const x = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    const dx = x - startX;

    // sensitivity: 120px drag = 1.0x scale change
    const delta = dx / 120;
    setScale(activeImg, startScale + delta);
  }

  function onUp(e){
    if(!activeImg) return;
    e.preventDefault();
    activeImg = null;
    window.removeEventListener('mousemove', onMove);
    window.removeEventListener('mouseup', onUp);
    window.removeEventListener('touchmove', onMove);
    window.removeEventListener('touchend', onUp);
  }

  document.addEventListener('mousedown', onDown, true);
  document.addEventListener('touchstart', onDown, {passive:false, capture:true});
})();
</script>


<script>
(function(){
  let targetImg = null;
  let targetBox = null;
  let targetBar = null;

  const input = document.getElementById('replaceLogoInput');

  function isProtected(el){
    return el && el.classList && (el.classList.contains('benefit-icon') || el.classList.contains('benefit-sep'));
  }

  function isLogoTarget(el){
    if(!el) return false;

    // Allow on images inside logos/promos
    if(el.tagName === 'IMG'){
      if(isProtected(el)) return false;
      return !!(el.closest('.logo-box') || el.closest('.promo-logo') || el.closest('.other-promos'));
    }

    // Allow right-click on the logo-box itself (including editable "待補" text)
    if(el.classList && el.classList.contains('logo-box')) return true;
    const box = el.closest ? el.closest('.logo-box') : null;
    return !!box;
  }

  function removeMenu(){
    const m = document.querySelector('.logo-context-menu');
    if(m) m.remove();
  }

  function openReplacePicker(){
    if(input) input.click();
  }

  function setFitByWidth(img){
    if(!img) return;
    try{ img.dataset.forceWidth = '1'; }catch(e){}
    try{ img.classList && img.classList.remove('fit-by-height'); }catch(e){}
    try{
      // Keep default css: width:100%; height:auto;
      img.style.width = '';
      img.style.height = '';
      img.style.maxHeight = '';
      img.style.maxWidth = '';
    }catch(e){}
  }

  function removeImageToPending(){
    const box = targetBox || (targetImg ? targetImg.closest('.logo-box') : null);
    if(box && typeof window.setBoxToPending === 'function'){
      window.setBoxToPending(box);
      return;
    }
    if(box){
      box.innerHTML = '待補';
      box.setAttribute('contenteditable', 'true');
      box.style.setProperty('background', '#fff', 'important');
      box.style.color = '#111';
      box.style.display = 'flex';
      box.style.alignItems = 'center';
      box.style.justifyContent = 'center';
    }
  }

  function removeBarCompletely(){
    // Remove the whole bar container (and its logo-box/img),
    // BUT keep orange/teal vertical slots fixed (no reflow) when removed.
    const bar = targetBar || (targetBox ? targetBox.closest('.bar') : (targetImg ? targetImg.closest('.bar') : null));
    if(!bar) return;

    const isFixedSlot = bar.classList && (bar.classList.contains('orange') || bar.classList.contains('teal'));

    if(isFixedSlot){
      // For orange/teal: visually remove but keep the slot height so the other one won't shift.
      try{ bar.classList.add('is-removed'); }catch(e){}
    }else{
      // For other bars (e.g., promo95/other promos): remove and allow reflow (fill the gap).
      try{ bar.remove(); }catch(e){}
    }

    // Refresh continuous bands
    try{ window.dispatchEvent(new Event('resize')); }catch(e){}
  }


  document.addEventListener('contextmenu', function(e){
    if(!isLogoTarget(e.target)) return;

    // Determine current target box/img/bar
    targetImg = null;
    targetBox = null;
    targetBar = null;

    if(e.target.tagName === 'IMG'){
      targetImg = e.target;
      targetBox = e.target.closest('.logo-box') || null;
      targetBar = e.target.closest('.bar') || null;
    }else{
      targetBox = e.target.closest('.logo-box') || (e.target.classList && e.target.classList.contains('logo-box') ? e.target : null);
      if(targetBox){
        targetBar = targetBox.closest('.bar') || null;
        const img = targetBox.querySelector('img');
        if(img) targetImg = img;
      }
    }

    // For promo/other-promos (not inside logo-box), we support replace + clear image only
    const isPromo = targetImg && (targetImg.closest('.promo-logo') || targetImg.closest('.other-promos')) && !targetImg.closest('.logo-box');

    e.preventDefault();
    removeMenu();

    const menu = document.createElement('div');
    menu.className = 'logo-context-menu';
    menu.style.left = e.clientX + 'px';
    menu.style.top = e.clientY + 'px';

    const btnReplace = document.createElement('button');
    btnReplace.textContent = '更換圖片';
    btnReplace.addEventListener('click', ()=>{
      removeMenu();
      openReplacePicker();
    });
    menu.appendChild(btnReplace);

    const btnRemove = document.createElement('button');
    btnRemove.textContent = isPromo ? '移除圖片' : '刪除圖片(回到待補)';
    btnRemove.addEventListener('click', ()=>{
      removeMenu();
      if(isPromo){
        targetImg.src = '';
      }else{
        removeImageToPending();
      }
    });
    menu.appendChild(btnRemove);

    // Remove bar (orange/teal keep slot; others reflow)
    if(!isPromo && targetBar){
      const btnRemoveBar = document.createElement('button');
      btnRemoveBar.textContent = '移除';
      btnRemoveBar.addEventListener('click', ()=>{
        removeMenu();
        removeBarCompletely();
      });
      menu.appendChild(btnRemoveBar);
    }

    document.body.appendChild(menu);
  });

  document.addEventListener('click', removeMenu);

  input && input.addEventListener('change', function(){
    const f = input.files && input.files[0];
    if(!f) return;

    // If right-clicked on pending logo-box (no img), create/replace into that box.
    if(!targetImg){
      const box = targetBox;
      if(!box){ input.value=''; return; }

      const url = URL.createObjectURL(f);
      if(typeof window.setBoxToImage === 'function'){
        window.setBoxToImage(box, url, f.name || '');
        // Ensure width-first after insert
        try{
          const img = box.querySelector('img');
          if(img) setFitByWidth(img);
        }catch(e){}
      }else{
        box.innerHTML = '';
        const img = document.createElement('img');
        img.alt = f.name || '';
        try{ img.dataset.forceWidth = '1'; }catch(e){}
        img.src = url;
        box.appendChild(img);
        setFitByWidth(img);
      }
      input.value='';
      return;
    }

    // Replace existing image
    const url = URL.createObjectURL(f);
    targetImg.src = url;

    // reset scale
    targetImg.dataset.scale = '1';
    targetImg.style.setProperty('--user-scale','1');
    targetImg.style.transform = ''; // handled by CSS

    // IMPORTANT: upload -> width-first (height auto)
    setFitByWidth(targetImg);

    // re-apply background sampling if available
    try{
      if(window.__applyLogoBoxBgFromImg) window.__applyLogoBoxBgFromImg(targetImg);
    }catch(e){}

    input.value = '';
  });
})();
</script>


<script>
(function(){
  // v4: Store ONLY what is actually used on canvas (KV chosen bg + logo/promo images + edits).
  // Reason: localStorage quota is small (~5MB). Storing whole folder maps (hundreds of images) will silently fail.
  // This version converts any blob:/file: logo src into dataURL before saving/exporting.

  const STORAGE_KEY = 'calendar_editor_persist_v5';

  const downloadCacheBtn = document.getElementById('downloadCacheBtn');
  const uploadCacheBtn = document.getElementById('uploadCacheBtn');
  const cacheFileInput = document.getElementById('cacheFileInput');
  const statusEl = document.getElementById('tbStatus');

  function setStatus(msg){ if(statusEl) statusEl.textContent = msg; }

  function isEditableImg(img){
    if(!img || img.tagName !== 'IMG') return false;
    if(img.classList && (img.classList.contains('benefit-icon') || img.classList.contains('benefit-sep'))) return false;
    return !!(img.closest('.logo-box') || img.closest('.promo-logo') || img.closest('.other-promos'));
  }

  function getCalBoxKey(cellIdx, barKey){
    return `cal:${cellIdx}:${barKey}`;
  }

  function getImgKey(img){
    const logoBox = img.closest('.logo-box');
    if(logoBox){
      const cell = logoBox.closest('.cell');
      const cellIdx = Math.max(0, Array.from(document.querySelectorAll('.grid .cell')).indexOf(cell));
      const bar = logoBox.closest('.bar');
      const barKey = bar && bar.classList.contains('orange') ? 'orange' : (bar && bar.classList.contains('teal') ? 'teal' : 'bar');
      return getCalBoxKey(cellIdx, barKey);
    }
    const promo = img.closest('.promo-logo');
    if(promo){
      const idx = Array.from(document.querySelectorAll('.promo-logo img')).indexOf(img);
      return `promo:${idx}`;
    }
    const other = img.closest('.other-promos');
    if(other){
      const idx = Array.from(other.querySelectorAll('img')).indexOf(img);
      return `other:${idx}`;
    }
    const all = Array.from(document.querySelectorAll('img')).indexOf(img);
    return `img:${all}`;
  }

  function ensureImgInLogoBox(box){
    let img = box.querySelector('img');
    if(img) return img;
    try{ box.classList.remove('is-pending'); }catch(e){}
    img = document.createElement('img');
    img.alt = '';
    img.decoding = 'async';
    img.loading = 'eager';
    box.textContent = '';
    box.appendChild(img);
    return img;
  }

  function findTargetByKey(key){
    if(!key) return null;

    // cal:<cellIdx>:<barKey>
    if(key.startsWith('cal:')){
      const parts = key.split(':');
      const cellIdx = parseInt(parts[1], 10);
      const barKey = parts[2] || 'bar';
      const cell = document.querySelectorAll('.grid .cell')[cellIdx];
      if(!cell) return null;
      const bar = cell.querySelector(`.bar.${barKey}`) || (barKey==='bar' ? cell.querySelector('.bar') : null);
      if(!bar) return null;
      const box = bar.querySelector('.logo-box');
      if(!box) return null;
      return { type:'logo-box', box };
    }

    // promo:<idx>
    if(key.startsWith('promo:')){
      const idx = parseInt(key.split(':')[1], 10);
      const img = document.querySelectorAll('.promo-logo img')[idx];
      return img ? { type:'img', img } : null;
    }

    // other:<idx>
    if(key.startsWith('other:')){
      const idx = parseInt(key.split(':')[1], 10);
      const other = document.querySelector('.other-promos');
      if(!other) return null;
      const img = other.querySelectorAll('img')[idx];
      return img ? { type:'img', img } : null;
    }

    return null;
  }

  // ---- src -> dataURL (only when needed) ----
  const _dataUrlCache = new Map();

  function _getImgSrc(img){
    return img.getAttribute('src') || img.src || '';
  }

  async function toDataUrlIfNeeded(src){
    const s = String(src || '');
    if(!s) return '';
    if(s.startsWith('data:')) return s;

    // Only convert blob:/file:/http(s) for editable logo images.
    // Using fetch + FileReader; best-effort.
    if(_dataUrlCache.has(s)) return _dataUrlCache.get(s);

    try{
      const resp = await fetch(s, { cache: 'force-cache' });
      const blob = await resp.blob();
      const dataUrl = await new Promise((res)=>{
        const fr = new FileReader();
        fr.onload = ()=>res(fr.result);
        fr.onerror = ()=>res('');
        fr.readAsDataURL(blob);
      });
      _dataUrlCache.set(s, dataUrl || '');
      return dataUrl || '';
    }catch(e){
      return s; // fallback keep original
    }
  }

  // ---- src -> thumbnail dataURL (downsample for smaller localStorage) ----
  const _thumbCache = new Map();

  function _supportWebp(){
    try{
      const c = document.createElement('canvas');
      const s = c.toDataURL('image/webp');
      return typeof s === 'string' && s.startsWith('data:image/webp');
    }catch(e){ return false; }
  }
  const _WEBP_OK = _supportWebp();

  async function _fetchBlob(src){
    const s = String(src || '');
    if(!s) return null;
    try{
      const resp = await fetch(s, { cache: 'force-cache' });
      if(!resp || !resp.ok) return null;
      return await resp.blob();
    }catch(e){
      return null;
    }
  }

  function _clamp(n, lo, hi){
    n = Number(n);
    if(!isFinite(n)) return lo;
    return Math.max(lo, Math.min(hi, n));
  }

  function _getThumbTargetFor(img){
    // Prefer the container we render into.
    const box = img.closest('.logo-box') || img.closest('.promo-logo') || img.closest('.other-promos') || img.parentElement;
    const w = (box && box.clientWidth) ? box.clientWidth : (img.naturalWidth || 160);
    const h = (box && box.clientHeight) ? box.clientHeight : (img.naturalHeight || 60);

    // Higher DPR for crisp logos after restore (avoid blur from aggressive downsampling).
    const scale = parseFloat(img.dataset.scale || '1');
    const s = isFinite(scale) ? scale : 1;
    const dpr = 4;

    const tw = Math.round(_clamp(w * dpr * s, 32, 1800));
    const th = Math.round(_clamp(h * dpr * s, 32, 1800));
    return { tw, th };
  }

  async function toThumbnailDataUrl(img){
    if(!img) return '';
    const src0 = _getImgSrc(img);
    if(!src0) return '';

    // If already a dataURL, we still downsample to keep storage small.
    const { tw, th } = _getThumbTargetFor(img);

    // Cache by (src + target + fitByHeight + scale) to avoid repeated work.
    const cacheKey = `${src0}@@${tw}x${th}@@${img.dataset.scale||'1'}@@${img.classList&&img.classList.contains('fit-by-height')?'H':'W'}`;
    if(_thumbCache.has(cacheKey)) return _thumbCache.get(cacheKey);

    const blob = await _fetchBlob(src0);
    if(!blob){
      // Best-effort fallback: keep original (may bloat if very large).
      const fallback = await toDataUrlIfNeeded(src0);
      _thumbCache.set(cacheKey, fallback || '');
      return fallback || '';
    }

    try{
      const bmp = await createImageBitmap(blob);
      const sw = bmp.width || 1;
      const sh = bmp.height || 1;

      // Fit source into target box while preserving aspect.
      const r = Math.min(tw / sw, th / sh);
      const dw = Math.max(1, Math.round(sw * r));
      const dh = Math.max(1, Math.round(sh * r));

      const canvas = document.createElement('canvas');
      canvas.width = dw;
      canvas.height = dh;
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.clearRect(0,0,dw,dh);
      ctx.drawImage(bmp, 0, 0, dw, dh);

      // Prefer webp; fallback jpeg.
      const quality = 0.98;
      let out = '';
      if(_WEBP_OK){
        out = canvas.toDataURL('image/webp', quality);
      }
      if(!out || !out.startsWith('data:image/')){
        // JPEG can't store transparency; if logo PNG is transparent, it will get black in some browsers.
        // We paint white background to keep it readable.
        ctx.globalCompositeOperation = 'destination-over';
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,dw,dh);
        ctx.globalCompositeOperation = 'source-over';
        out = canvas.toDataURL('image/jpeg', quality);
      }

      try{ bmp.close && bmp.close(); }catch(e){}
      _thumbCache.set(cacheKey, out || '');
      return out || '';
    }catch(e){
      const fallback = await toDataUrlIfNeeded(src0);
      _thumbCache.set(cacheKey, fallback || '');
      return fallback || '';
    }
  }


  // ---- Collect edits (async so we can inline blob URLs) ----
  async function collectLogoEdits(){
    const edits = {};

    // Calendar logo-boxes
    const cells = Array.from(document.querySelectorAll('.grid .cell'));
    for(let ci=0; ci<cells.length; ci++){
      const cell = cells[ci];
      const bars = Array.from(cell.querySelectorAll('.bar'));
      for(const bar of bars){
        const barKey = bar.classList.contains('orange') ? 'orange' : (bar.classList.contains('teal') ? 'teal' : 'bar');
        const box = bar.querySelector('.logo-box');
        if(!box) continue;

        const removed = !!(bar.classList && bar.classList.contains('is-removed'));

        const key = getCalBoxKey(ci, barKey);
        const img = box.querySelector('img');
        if(!img){
          edits[key] = { cleared: true, removed };
          continue;
        }

        const scale = parseFloat(img.dataset.scale || '1');
        const src = await toDataUrlIfNeeded(_getImgSrc(img));
        edits[key] = {
          cleared: false,
          src,
          scale: (isFinite(scale) ? scale : 1),
          fitByHeight: !!(img.classList && img.classList.contains('fit-by-height')),
          removed
        };
      }
    }

    // Promo + other promos
    const imgs = Array.from(document.querySelectorAll('.promo-logo img, .other-promos img')).filter(isEditableImg);
    for(const img of imgs){
      const key = getImgKey(img);
      const scale = parseFloat(img.dataset.scale || '1');
      const src = await toDataUrlIfNeeded(_getImgSrc(img));
      edits[key] = {
        cleared: false,
        src,
        scale: (isFinite(scale) ? scale : 1),
        fitByHeight: !!(img.classList && img.classList.contains('fit-by-height'))
      };
    }

    return edits;
  }

  function applyLogoEdits(edits){
    if(!edits) return;

    for(const [key, v] of Object.entries(edits)){
      const target = findTargetByKey(key);
      if(!target) continue;

      if(target.type === 'logo-box'){
        const box = target.box;

        // Persist "remove bar" without shifting positions: hide the bar but keep its slot.
        try{
          const bar = box.closest('.bar');
          if(bar && (bar.classList.contains('orange') || bar.classList.contains('teal'))){
            if(v && v.removed) bar.classList.add('is-removed');
            else bar.classList.remove('is-removed');
          }
        }catch(e){}

        if(v && v.cleared){
          const img = box.querySelector('img');
          if(img) img.remove();
          box.textContent = '待補';
          try{ box.classList.add('is-pending'); }catch(e){}
          continue;
        }

        const img = ensureImgInLogoBox(box);
        try{ box.classList.remove('is-pending'); }catch(e){}
        if(v && typeof v.src === 'string' && v.src){
          img.src = v.src;
        }


        try{
          if(img.classList){
            if(v && v.fitByHeight) img.classList.add('fit-by-height');
            else img.classList.remove('fit-by-height');
          }
        }catch(e){}

        const s = (v && v.scale != null) ? parseFloat(v.scale) : 1;
        if(isFinite(s)){
          img.dataset.scale = String(s);
          img.style.setProperty('--user-scale', String(s));
          img.style.transform = '';
        }

        try{ if(window.__applyLogoBoxBgFromImg) setTimeout(()=>window.__applyLogoBoxBgFromImg(img), 0); }catch(e){}
        continue;
      }

      if(target.type === 'img'){
        const img = target.img;
        if(v && typeof v.src === 'string' && v.src){
          img.src = v.src;
        }

        try{
          if(img.classList){
            if(v && v.fitByHeight) img.classList.add('fit-by-height');
            else img.classList.remove('fit-by-height');
          }
        }catch(e){}
        const s = (v && v.scale != null) ? parseFloat(v.scale) : 1;
        if(isFinite(s)){
          img.dataset.scale = String(s);
          img.style.setProperty('--user-scale', String(s));
          img.style.transform = '';
        }
      }
    }
  }

  function getHeroDataUrl(){
    const hero = document.querySelector('#canvas .hero') || document.querySelector('.hero');
    if(!hero) return '';
    return (hero.dataset && hero.dataset.kvSrc) ? hero.dataset.kvSrc : '';
  }

  async function collectState(){
    return {
      version: 5,
      savedAt: new Date().toISOString(),
      heroBg: getHeroDataUrl(),
      logoInsetPct: (()=>{ try{ return parseFloat(localStorage.getItem('calendar_logo_inset_pct')||'10') }catch(e){ return 10; } })(),
      calendarData: window.__lastCalendarData || null,
      logoEdits: await collectLogoEdits()
    };
  }

  // ---- Save / load ----
  let _saveTimer = null;
  function scheduleSave(delay){
    if(_saveTimer) clearTimeout(_saveTimer);
    _saveTimer = setTimeout(async ()=>{
      try{
        const st = await collectState();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
      }catch(e){
        // If quota exceeded, show a helpful hint once.
        // (We keep silent most of the time to avoid noise.)
      }
    }, delay || 250);
  }

  async function restoreFromState(st){
    if(!st) return;

    // If calendarData exists, render first
    if(st.calendarData){
      window.__lastCalendarData = st.calendarData;
      try{
        if(window.__kv_applyToHtml) await window.__kv_applyToHtml(st.calendarData);
      }catch(e){}
    }

    // Restore Logo inset
    try{
      if(st.logoInsetPct != null){
        const v = parseFloat(st.logoInsetPct);
        if(isFinite(v)){
          localStorage.setItem('calendar_logo_inset_pct', String(v));
          const root = document.documentElement;
          const pct = Math.max(0, Math.min(30, v));
          const scale = (100 - pct) / 100;
          root.style.setProperty('--logo-inset-pct', pct.toFixed(1));
          root.style.setProperty('--logo-inset-scale', scale.toFixed(4));
          const slider = document.getElementById('logoInsetRange');
          const out = document.getElementById('logoInsetVal');
          if(slider) slider.value = String(pct);
          if(out) out.textContent = pct.toFixed(1).replace(/\.0$/, '');
        }
      }
    }catch(e){}

    // Restore KV
    try{
      if(st.heroBg && window.__kv_applyHeroBg){
        window.__kv_applyHeroBg(st.heroBg);
      }else if(st.heroBg){
        const hero = document.querySelector('#canvas .hero') || document.querySelector('.hero');
        if(hero) hero.style.backgroundImage = `url("${st.heroBg}")`;
      }
    }catch(e){}

    // Apply logos last
    try{ applyLogoEdits(st.logoEdits); }catch(e){}
  }

  function loadState(){
    // Prefer v4; fallback to v3/v2
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}

    try{
      const raw3 = localStorage.getItem('calendar_editor_persist_v3');
      if(raw3) return JSON.parse(raw3);
    }catch(e){}

    try{
      const raw2 = localStorage.getItem('calendar_editor_persist_v2');
      if(raw2) return JSON.parse(raw2);
    }catch(e){}

    return null;
  }

  // Auto-restore on load
  window.addEventListener('DOMContentLoaded', async ()=>{
    const st = loadState();
    if(!st) return;
    setStatus('已載入暫存，套用中...');
    await restoreFromState(st);
    setStatus('已還原暫存');
  });

  // Save on common edit actions
  const kvDirInput = document.getElementById('kvDirInput');
  const logoDirInput = document.getElementById('logoDirInput');
  const replaceLogoInput = document.getElementById('replaceLogoInput');

  kvDirInput && kvDirInput.addEventListener('change', ()=> scheduleSave(600), true);
  logoDirInput && logoDirInput.addEventListener('change', ()=> scheduleSave(900), true);
  replaceLogoInput && replaceLogoInput.addEventListener('change', ()=> scheduleSave(900), true);

  document.addEventListener('mouseup', ()=> scheduleSave(350), true);
  document.addEventListener('touchend', ()=> scheduleSave(350), true);
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.tagName === 'IMG' && isEditableImg(t)) scheduleSave(350);
  }, true);

  // Download cache JSON
  downloadCacheBtn && downloadCacheBtn.addEventListener('click', async ()=>{
    try{
      setStatus('打包暫存檔中...');
      const st = await collectState();
      const blob = new Blob([JSON.stringify(st, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'calendar-editor-cache.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setStatus('已下載暫存檔');
    }catch(e){
      setStatus('下載暫存失敗');
    }
  });

  // Upload cache JSON
  uploadCacheBtn && uploadCacheBtn.addEventListener('click', ()=>{
    if(cacheFileInput){
      // Reset value so selecting the same file still triggers "change" in all browsers.
      cacheFileInput.value = '';
      cacheFileInput.click();
    }
  });

  cacheFileInput && cacheFileInput.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    try{
      let txt = await f.text();
      // Handle UTF-8 BOM / invisible leading chars that can break JSON.parse.
      txt = String(txt || '').replace(/^\uFEFF/, '').trim();

      // Some older exports may be double-stringified.
      let st = JSON.parse(txt);
      if(typeof st === 'string'){
        st = JSON.parse(st);
      }

      if(!st || typeof st !== 'object'){
        throw new Error('Invalid cache JSON: not an object');
      }

      setStatus('已讀取暫存檔，套用中...');
      await restoreFromState(st);

      // Best-effort: store for next auto-restore.
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
      }catch(saveErr){
        // Most common: QuotaExceededError when cache includes high-res images.
        console.warn(saveErr);
        setStatus('已套用暫存檔（但瀏覽器暫存容量不足，無法保存到本機暫存）');
        e.target.value = '';
        return;
      }

      setStatus('已套用暫存檔');
    }catch(err){
      console.error(err);
      // Split common errors to be more actionable.
      const msg = (err && err.name === 'SyntaxError')
        ? '暫存檔不是合法 JSON（可能有多餘逗號/被截斷）'
        : '暫存檔格式錯誤/讀取失敗';
      setStatus(msg);
    }
    e.target.value = '';
  });
})();
</script>

</body>
</html>
